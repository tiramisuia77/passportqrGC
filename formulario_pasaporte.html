<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitud de Tramites Consulares</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
        /* Estilos generales (sin cambios significativos respecto a la versión anterior) */
        body {
            font-family: Arial, sans-serif;
            line-height: 1.4;
            margin: 0;
            padding: 15px;
            color: #333;
            background-color: #f4f4f4;
            position: relative;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 70px; /* Espacio para el footer */
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background-image: url('img/escudo_cuba_lineas_azul.png');
            background-position: center 15px;
            background-repeat: no-repeat;
            opacity: 0.1;
            z-index: -1;
            pointer-events: none;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            margin: 3px 0;
            font-size: 22px;
        }

        .header h2 {
            margin: 3px 0;
            font-size: 16px;
            font-weight: normal;
            color: #777;
        }

        .form-section {
            margin-bottom: 15px;
            border: 1px solid rgba(221, 221, 221, 0.6);
            padding: 15px;
            border-radius: 6px;
            background-color: rgba(255, 255, 255, 0);
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .form-title {
            background-color: rgba(224, 224, 224, 0.9);
            color: #333;
            padding: 8px 12px;
            margin: -15px -15px 15px -15px;
            border-bottom: 1px solid rgba(204, 204, 204, 0.6);
            font-weight: bold;
            font-size: 16px;
            border-radius: 6px 6px 0 0;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
            align-items: flex-start;
        }

        .form-group {
            flex: 1;
            min-width: 140px;
        }

        .form-group.width-auto {
            flex: 0 1 auto;
            min-width: auto;
        }

        .form-group.width-small {
            flex: 0 1 90px;
            min-width: 70px;
        }

        .form-group.width-medium {
            flex: 0 1 160px;
            min-width: 140px;
        }

        .form-group.width-large {
            flex: 1 1 230px;
            min-width: 180px;
        }

        .form-group.full-width {
            flex: 1 1 100%;
            min-width: 100%;
        }

        label {
            display: block;
            margin-bottom: 3px;
            font-weight: bold;
            font-size: 13px;
            color: #555;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 14px;
        }

        input[type="text"],
        input[type="tel"],
        textarea {
            text-transform: uppercase;
        }

        input[type="email"] {
            text-transform: lowercase;
        }

        input[type="number"] {
            -webkit-appearance: none;
            -moz-appearance: textfield;
            appearance: textfield;
            margin: 0;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        select:disabled,
        input:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
            opacity: 0.7;
        }

        input[type="date"] {
            padding: 7px;
            font-size: 14px;
        }

        .photo-box {
            border: 2px dashed #bbb;
            width: 160px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            color: #777;
            font-size: 13px;
            box-sizing: border-box;
        }

        .signature-box {
            border: 1px solid #999;
            width: 100%;
            height: 200px;
            margin-top: 3px;
            background-color: #fff;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-style: italic;
            box-sizing: border-box;
        }

        .qr-container {
            margin: 20px auto;
            text-align: center;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            display: block;
            width: fit-content;
            border-radius: 5px;
        }

        #qrCode>div {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 13px;
        }

        #qrCode canvas,
        #qrCode img {
            max-width: 100%;
            height: auto;
        }

        .btn-container {
            text-align: center;
            margin: 15px 0;
        }

        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            margin: 5px;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:hover:enabled {
            background-color: #0056b3;
        }

        .residence-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 13px;
        }

        .residence-table th,
        .residence-table td {
            border: 1px solid #ddd;
            padding: 5px;
            text-align: left;
        }

        .residence-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        .residence-table td:first-child {
            width: 60%;
        }

        .residence-table td:nth-child(2),
        .residence-table td:nth-child(3) {
            width: 20%;
        }

        .residence-table input[type="text"] {
            border: none;
            padding: 3px;
            font-size: 13px;
        }

        .residence-table input[type="number"] {
            border: none;
            padding: 3px;
            font-size: 13px;
            width: 100%;
            -moz-appearance: textfield;
            appearance: textfield;
        }

        .declaration {
            font-style: italic;
            margin: 15px 0;
            padding: 10px;
            background-color: #f9f9f9;
            border-left: 4px solid #ccc;
            border-radius: 4px;
            color: #555;
            font-size: 13px;
        }

        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 15px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error-field {
            border: 2px solid #ff4444 !important;
            background-color: #fff3f3 !important;
        }

        /* --- Print-specific styles --- */
        @media print {
            body {
                background-color: #fff;
                padding: 0;
                font-size: 8.5pt;
                /* Further reduced base font size */
                line-height: 1.25;
                /* Further reduced line-height */
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;

            }

            #form-to-print {
                max-width: 100%;
                padding: 5mm;
                box-shadow: none;
                border-radius: 0;
                border: none;
                /* Remove border for print */
            }

            .form-section {
                border: 1px solid #ccc;
                box-shadow: none;
                margin-bottom: 6px;
                /* Further reduced margin */
                padding: 6px;
                /* Further reduced padding */
                page-break-inside: avoid;
                /* Keep avoid on sections */
            }

            .form-title {
                margin: -6px -6px 6px -6px;
                /* Adjust title margin */
                padding: 4px 6px;
                /* Reduced padding */
                font-size: 10pt;
                /* Further reduced font size */
            }

            .form-row {
                margin-bottom: 5px;
                /* Further reduced margin */
                gap: 5px;
                /* Further reduced gap */
            }

            label {
                font-size: 8.5pt;
                /* Match body font size */
                margin-bottom: 1px;
                /* Further reduced margin */
            }

            input,
            select,
            textarea {
                font-size: 8.5pt;
                /* Match body font size */
                padding: 3px;
                /* Further reduced padding */
                border-radius: 2px;
                /* Smaller radius */
                border: 1px solid #bbb;
                /* Lighter border */
            }

            input[type="date"] {
                padding: 2px;
            }

            .photo-box {
                width: 35mm;
                height: 45mm;
                font-size: 7pt;
                padding: 4px;
                margin-bottom: 4px;
                border-style: solid;
                border-width: 1px;
                border-color: #ccc;
                /* Solid border for print */
            }

            .signature-box {
                height: 18mm;
                /* Slightly reduced */
                margin-top: 1px;
                border: 1px solid #aaa;
            }

            .residence-table {
                font-size: 7.5pt;
                /* Further reduced */
                margin: 4px 0;
            }

            .residence-table th,
            .residence-table td {
                padding: 2px;
                /* Further reduced padding */
            }

            .residence-table input {
                padding: 1px;
                font-size: 7.5pt;
            }

            .declaration {
                font-size: 7.5pt;
                padding: 4px;
                margin: 6px 0;
                border-left-width: 3px;
            }

            .qr-container {
                page-break-inside: avoid;
                margin: 8px auto;
                padding: 4px;
                border: 1px solid #aaa;
            }

            #qrCode>div {
                font-size: 7pt;
                margin-bottom: 2px;
            }

            #qrCode canvas,
            #qrCode img {
                max-width: 35mm;
            }

            /* Reduced QR size */

            .no-print,
            .no-print * {
                /* Aplica a todos los hijos */
                display: none !important;
            }

            /* Removed page-break-inside: avoid from form-group and date-input-group */

        }

        /* Container for date inputs */
        .date-input-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .date-input-group input[type="number"] {
            width: 60px;
            flex: 0 0 auto;
        }

        .date-input-group input::placeholder {
            font-size: 11px;
            color: #999;
        }

        /* Main form container */
        #form-to-print {
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
            box-sizing: border-box;
            position: relative;
            /* background-color: #fff;  */
            /* box-shadow: 0 0 10px rgba(0,0,0,0.1); */
            border-radius: 6px;
        }

        /* Toastify notification styling */
        .toastify {
            font-family: Arial, sans-serif;
            padding: 10px 18px;
            color: #ffffff;
            border-radius: 4px;
            font-size: 13px;
            z-index: 1001;
        }

        .toastify.error {
            background: linear-gradient(135deg, #ff4444, #cc0000);
        }

        .toastify.success {
            background: linear-gradient(135deg, #00C851, #007E33);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            #form-to-print {
                padding: 10px;
            }

            .form-row {
                flex-direction: column;
                gap: 5px;
                /* Reducido de 8px a 5px */
                margin-bottom: 5px;
                /* Añadido para reducir espacio vertical */
            }

            .form-group {
                min-width: 100%;
                width: 100%;
                margin-bottom: 5px;
                /* Añadido para reducir espacio vertical */
            }

            .form-section {
                margin-bottom: 10px;
                /* Reducido el margen inferior */
                padding: 10px;
                /* Reducido el padding */
            }

            .date-input-group {
                flex-wrap: wrap;
                gap: 5px;
            }

            .date-input-group input[type="number"] {
                width: calc(33% - 4px);
            }

            /* .photo-box { width: 140px; height: 170px; } */
            .header h1 {
                font-size: 18px;
            }

            .header h2 {
                font-size: 15px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            #form-to-print {
                padding: 8px;
            }

            .form-row {
                gap: 3px;
                /* Reducido aún más para pantallas muy pequeñas */
                margin-bottom: 3px;
                /* Reducido aún más para pantallas muy pequeñas */
            }

            .form-group {
                margin-bottom: 3px;
                /* Reducido aún más para pantallas muy pequeñas */
            }

            .header h1 {
                font-size: 16px;
            }

            .header h2 {
                font-size: 13px;
            }

            button {
                font-size: 14px;
                padding: 8px 15px;
            }

            .date-input-group input[type="number"] {
                width: calc(33% - 4px);
            }

            /* .photo-box { width: 110px; height: 140px; } */
            label {
                font-size: 12px;
            }

            input,
            select,
            textarea {
                font-size: 13px;
                padding: 6px;
                margin-bottom: 2px;
                /* Añadido para reducir espacio vertical */
            }
        }

        /* Estilo para el footer fijo */
        .fixed-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #f8f9fa;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            padding: 10px 0;
            text-align: center;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            border-top: 1px solid #ddd;
        }

        .fixed-footer button {
            margin: 0 10px;
        }

        @media print {
            .fixed-footer {
                display: none !important;
            }
        }

        /* Media queries responsivas para el footer */
        @media (max-width: 768px) {
            body {
                padding-bottom: 60px;
            }
            
            .fixed-footer {
                padding: 8px 0;
            }
            
            .fixed-footer button {
                padding: 8px 15px;
                font-size: 14px;
                margin: 0 5px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding-bottom: 50px;
            }
            
            .fixed-footer {
                padding: 6px 0;
            }
            
            .fixed-footer button {
                padding: 6px 12px;
                font-size: 13px;
                margin: 0 3px;
            }
        }
    </style>
</head>

<body>
    <div id="loader">
        <div style="background: white; padding: 30px; border-radius: 8px; text-align: center;">
            <p style="font-size: 18px; margin-bottom: 15px;">Generando PDF, por favor espere...</p>
            <div class="spinner"></div>
        </div>
    </div>

    <div id="form-to-print">
        <div class="header">
            <h1>SOLICITUD DE TRÁMITES CONSULARES</h1>
            <h2>REPÚBLICA DE CUBA</h2>
        </div>

        <div class="form-section">
            <div class="form-title">DATOS INICIALES</div>
            <div class="form-row">
                <div class="form-group">
                    <label for="fechaSolicitud">Fecha de Solicitud</label>
                    <input type="date" id="fechaSolicitud" name="fechaSolicitud" required>
                </div>
                <div class="form-group">
                    <label for="tramite">Tipo de Trámite:</label>
                    <select id="tramite" name="tramite" required>
                        <option value="">Seleccione</option>
                        <option value="primera_vez">Pasaporte primera Vez</option>
                        <option value="renovacion">Pasaporte Renovación</option>
                        <option value="ccv">CCV</option>
                        <option value="pe-1">H-1</option>
                    </select>
                </div>
            </div>
            <!-- </div>

        <div class="form-section">  -->

            <div class="form-row">
                <hr>
                <div class="form-group" style="flex: 1;">
                    <label>Foto del Solicitante</label>
                    <div class="photo-box" id="photoPreviewContainer">
                        <input type="file" id="photoInput" accept="image/*" style="display: none;"
                            onchange="handlePhotoUpload(this)">
                        <div id="photoPreview">
                            <div id="photoPlaceholder">
                                FOTO<br>(4 x 4.5 cm)<br>
                                <small style="font-size: 11px;">
                                    - Fondo blanco<br>
                                    - Rostro centrado<br>
                                    - Sin lentes ni accesorios<br>
                                    - Formato JPG/PNG
                                </small>
                            </div>
                            <img id="uploadedPhoto"
                                style="display: none; max-width: 100%; max-height: 100%; object-fit: contain;">
                        </div>
                    </div>
                    <div class="no-print" style="text-align: center; width: 150px;">
                        <button type="button" onclick="document.getElementById('photoInput').click()" style="background-color: #007bff; color: white; border: none; width: 100%;
                                       padding: 5px; border-radius: 3px; font-size: 12px; cursor: pointer;">
                            Subir Foto
                        </button>
                    </div>
                </div>
                <div class="form-group" style="flex: 2;">
                    <label>Firma del Solicitante</label>
                    <div class="signature-box">
                        Firmar dentro de este espacio
                    </div>
                </div>
            </div>
            <!-- </div>

        <div class="form-section"> -->
            <br>

            <div class="form-title">DATOS GENERALES</div>
            <div class="form-row">
                <div class="form-group"> <label for="paisResidencia">País de Residencia</label>
                    <select id="paisResidencia" name="paisResidencia" required>
                        <option value="">Seleccione</option>
                    </select>
                </div>
                <div class="form-group"> <label for="consulado">Consulado</label>
                    <select id="consulado" name="consulado" required disabled>
                        <option value="">Seleccione un consulado</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group"> <label for="numeroPasaporte">Número de Pasaporte</label>
                    <input type="text" id="numeroPasaporte" name="numeroPasaporte" required>
                </div>
                <div class="form-group"> <label for="carneIdentidad">Carné de Identidad</label>
                    <input type="text" id="carneIdentidad" name="carneIdentidad" pattern="[0-9]{11}"
                        oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 11)"
                        onblur="validateCubanID(this)"
                        title="Debe contener 11 dígitos y ser un carné de identidad válido">
                </div>
                <div class="form-group">
                    <label for="fechaNacimiento">Fecha de Nacimiento</label>
                    <input type="date" id="fechaNacimiento" name="fechaNacimiento" required>
                </div>
                <div class="form-group"> <label for="sexo">Sexo</label>
                    <select id="sexo" name="sexo" required>
                        <option value="">Seleccione</option>
                        <option value="masculino">M</option>
                        <option value="femenino">F</option>
                    </select>
                </div>

            </div>
            <div class="form-row">
                <div class="form-group" style="flex: 1;"> <label for="primerApellido">Primer Apellido</label>
                    <input type="text" id="primerApellido" name="primerApellido" required>
                </div>
                <div class="form-group" style="flex: 1;"> <label for="segundoApellido">Segundo Apellido</label>
                    <input type="text" id="segundoApellido" name="segundoApellido">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group" style="flex: 1;"> <label for="primerNombre">Primer Nombre</label>
                    <input type="text" id="primerNombre" name="primerNombre" required>
                </div>
                <div class="form-group" style="flex: 1;"> <label for="segundoNombre">Segundo Nombre</label>
                    <input type="text" id="segundoNombre" name="segundoNombre">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="nombrePadre">Hijo de: Padre</label>
                    <input type="text" id="nombrePadre" name="nombrePadre">
                </div>
                <div class="form-group">
                    <label for="nombreMadre">y Madre</label>
                    <input type="text" id="nombreMadre" name="nombreMadre">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="paisNacimiento">País de Nacimiento</label>
                    <select id="paisNacimiento" name="paisNacimiento" required>
                        <option value="">Seleccione</option>
                    </select>
                </div>
                <div class="form-group" id="provinciaNacimientoContainer">
                    <label for="provinciaNacimiento">Provincia de Nacimiento</label>
                    <select id="provinciaNacimiento" name="provinciaNacimiento" required disabled>
                        <option value="">Seleccione país y año</option>
                    </select>
                    <input type="text" id="provinciaNacimientoText" name="provinciaNacimientoText"
                        style="display: none;">
                </div>
                <div class="form-group" id="municipioNacimientoContainer">
                    <label for="municipioNacimiento">Municipio de Nacimiento</label>
                    <select id="municipioNacimiento" name="municipioNacimiento" required disabled>
                        <option value="">Seleccione provincia</option>
                    </select>
                    <input type="text" id="municipioNacimientoText" name="municipioNacimientoText"
                        style="display: none;">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="colorOjos">Color de Ojos</label>
                    <select id="colorOjos" name="colorOjos">
                        <option value="">Seleccione</option>
                        <option value="claros">Claros</option>
                        <option value="negros">Negros</option>
                        <option value="pardos">Pardos</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="colorPiel">Color de Piel</label>
                    <select id="colorPiel" name="colorPiel">
                        <option value="">Seleccione</option>
                        <option value="blanca">Blanca</option>
                        <option value="negra">Negra</option>
                        <option value="amarilla">Amarilla</option>
                        <option value="mulata">Mulata</option>
                        <option value="albina">Albina</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="colorCabello">Color de Cabello</label>
                    <select id="colorCabello" name="colorCabello">
                        <option value="">Seleccione</option>
                        <option value="negro">Negro</option>
                        <option value="canoso">Canoso</option>
                        <option value="rubio">Rubio</option>
                        <option value="castaño">Castaño</option>
                        <option value="rojo">Rojo</option>
                        <option value="otros">Otros</option>
                    </select>
                </div>
            </div>

            <div class="form-row">

                <div class="form-group width-small"> <label for="estatura">Estatura (cm)</label>
                    <input type="number" id="estatura" name="estatura" min="100" max="250">
                </div>
                <div class="form-group"> <label for="estadoCivil">Estado Civil</label>
                    <select id="estadoCivil" name="estadoCivil">
                        <option value="">Seleccione</option>
                        <option value="soltero">Soltero</option>
                        <option value="casado">Casado</option>
                        <option value="viudo">Viudo</option>
                        <option value="divorciado">Divorciado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Fecha de salida de Cuba</label>
                    <div class="date-input-group">
                        <input type="number" id="diaSalida" name="diaSalida" placeholder="Día" min="1" max="31">
                        <input type="number" id="mesSalida" name="mesSalida" placeholder="Mes" min="1" max="12">
                        <input type="number" id="anoSalida" name="anoSalida" placeholder="Año" min="1900" max="2100">
                    </div>
                </div>
            </div>


            <!-- </div>

        <div class="form-section"> -->
            <br>
            <br>

            <div class="form-title">LUGAR DE RESIDENCIA ACTUAL</div>
            <div class="form-row">
                <div class="form-group" style="flex-basis: 60%;">
                    <label for="direccionResidencia">Dirección (calle, Ave. Nro. Entre Calles)</label>
                    <input type="text" id="direccionResidencia" name="direccionResidencia" required>
                </div>
                <div class="form-group" style="flex-basis: 35%;"> <label for="codigoPostalResidencia">Código
                        Postal</label>
                    <input type="text" id="codigoPostalResidencia" name="codigoPostalResidencia">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="provinciaEstadoResidencia">Provincia - Estado - Región</label>
                    <input type="text" id="provinciaEstadoResidencia" name="provinciaEstadoResidencia" required>
                </div>
                <div class="form-group">
                    <label for="paisResidenciaActual">País</label>
                    <select id="paisResidenciaActual" name="paisResidenciaActual" required></select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="telefonoResidencia">Teléfono</label>
                    <input type="tel" id="telefonoResidencia" name="telefonoResidencia" required>
                </div>
                <div class="form-group">
                    <label for="emailResidencia">E-Mail</label>
                    <input type="email" id="emailResidencia" name="emailResidencia" required
                        oninput="this.value = this.value.toLowerCase()" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                        title="Por favor introduzca una dirección de correo válida">
                </div>
                <div class="form-group">
                    <label for="faxResidencia">Fax</label>
                    <input type="tel" id="faxResidencia" name="faxResidencia">
                </div>
            </div>
            <!-- </div>

        <div class="form-section"> -->
            <br>
            <br>

            <div class="form-title">DATOS LABORALES O DE ESTUDIO</div>
            <div class="form-row">
                <div class="form-group full-width">
                    <label for="nombreCentroTrabajo">Nombre del Centro de Trabajo/Estudio</label>
                    <input type="text" id="nombreCentroTrabajo" name="nombreCentroTrabajo">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="nivelCultural">Nivel Cultural</label>
                    <select id="nivelCultural" name="nivelCultural" required>
                        <option value="">Seleccione</option>
                        <option value="primaria">Primaria</option>
                        <option value="secundaria">Secundaria</option>
                        <option value="preuniversitario">Preuniversitario</option>
                        <option value="universitario">Universitario</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="profesionTrabajo">Profesión</label>
                    <input type="text" id="profesionTrabajo" name="profesionTrabajo">
                </div>
                <div class="form-group">
                    <label for="ocupacionTrabajo">Ocupación</label>
                    <input type="text" id="ocupacionTrabajo" name="ocupacionTrabajo">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group full-width">
                    <label for="direccionTrabajo">Dirección (calle, Ave., Nro., Entre Calles)</label>
                    <input type="text" id="direccionTrabajo" name="direccionTrabajo">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="codigoPostalTrabajo">Código Postal</label>
                    <input type="text" id="codigoPostalTrabajo" name="codigoPostalTrabajo">
                </div>
                <div class="form-group">
                    <label for="provinciaEstadoTrabajo">Provincia - Estado - Región</label>
                    <input type="text" id="provinciaEstadoTrabajo" name="provinciaEstadoTrabajo">
                </div>
                <div class="form-group">
                    <label for="paisTrabajo">País</label>
                    <select id="paisTrabajo" name="paisTrabajo"></select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="telefonoTrabajo">Teléfono</label>
                    <input type="tel" id="telefonoTrabajo" name="telefonoTrabajo">
                </div>
                <div class="form-group">
                    <label for="emailTrabajo">E-Mail</label>
                    <input type="email" id="emailTrabajo" name="emailTrabajo"
                        oninput="this.value = this.value.toLowerCase()" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                        title="Por favor introduzca una dirección de correo válida">
                </div>
                <div class="form-group">
                    <label for="faxTrabajo">Fax</label>
                    <input type="tel" id="faxTrabajo" name="faxTrabajo">
                </div>
            </div>
            <!-- </div>

        <div class="form-section"> -->
            <br>
            <br>
            <div class="form-title">INFORMACIÓN ADICIONAL</div>
            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label for="referenciaNombre">Nombre y Apellidos de la Referencia en Cuba</label>
                    <input type="text" id="referenciaNombre" name="referenciaNombre">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="tipoVinculo">Tipo de vínculo</label>
                    <select id="tipoVinculo" name="tipoVinculo">
                        <option value="">Seleccione</option>                        
                        <option value="208">Esposo(a)</option>
                        <option value="281">Abuelo(a)</option>
                        <option value="282">Vecino(a)</option>
                        <option value="283">Representante Legal</option>
                        <option value="284">Padre</option>
                        <option value="285">Madre</option>
                        <option value="286">Hermano(a)</option>
                        <option value="287">Trabajador Social(a)</option>
                        <option value="288">Primo(a)</option>
                        <option value="289">Tío(a)</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label for="referenciaDireccion">Dirección de la Referencia</label>
                    <input type="text" id="referenciaDireccion" name="referenciaDireccion">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="referenciaProvincia">Provincia</label>
                    <select id="referenciaProvincia" name="referenciaProvincia">
                        <option value="">Seleccione provincia</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="referenciaMunicipio">Municipio</label>
                    <select id="referenciaMunicipio" name="referenciaMunicipio" disabled>
                        <option value="">Seleccione municipio</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group full-width">
                    <label>Lugar de Residencia en Cuba (dos últimas direcciones)</label>
                    <table class="residence-table">
                        <thead>
                            <tr>
                                <th>Dirección</th>
                                <th>Desde</th>
                                <th>Hasta</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input type="text" style="width: 100%;" name="direccionCuba1" id="direccionCuba1">
                                </td>
                                <td><input type="number" style="width: 100%;" name="desdeCuba1" id="desdeCuba1"
                                        min="1900" max="2025" placeholder="AAAA"></td>
                                <td><input type="number" style="width: 100%;" name="hastaCuba1" id="hastaCuba1"
                                        min="1900" max="2025" placeholder="AAAA"></td>
                            </tr>
                            <tr>
                                <td><input type="text" style="width: 100%;" name="direccionCuba2" id="direccionCuba2">
                                </td>
                                <td><input type="number" style="width: 100%;" name="desdeCuba2" id="desdeCuba2"
                                        min="1900" max="2025" placeholder="AAAA"></td>
                                <td><input type="number" style="width: 100%;" name="hastaCuba2" id="hastaCuba2"
                                        min="1900" max="2025" placeholder="AAAA"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- </div>

        <div class="form-section"> -->
            <br>
            <br>
            <div class="form-title">DOCUMENTOS</div>
            <div class="form-row">
                <div class="form-group full-width">
                    <label>Pasaporte vencido</label>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" placeholder="Número" name="pasaporteNumeroVencido"
                                id="pasaporteNumeroVencido">
                        </div>
                        <div class="form-group">
                            <input type="text" placeholder="Fecha expedición" name="pasaporteFechaExpedicionVencido"
                                id="pasaporteFechaExpedicionVencido">
                        </div>
                        <div class="form-group">
                            <input type="text" placeholder="Lugar" name="pasaporteLugarExpedicionVencido"
                                id="pasaporteLugarExpedicionVencido">
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group full-width">
                    <label>Certificación de Nacimiento</label>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" placeholder="Tomo" name="certNacimientoTomo" id="certNacimientoTomo">
                        </div>
                        <div class="form-group">
                            <input type="text" placeholder="Folio" name="certNacimientoFolio" id="certNacimientoFolio">
                        </div>
                        <div class="form-group">
                            <input type="text" placeholder="Registro Civil" name="certNacimientoRegistroCivil"
                                id="certNacimientoRegistroCivil">
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group full-width">
                    <label>Inscripción Consular</label>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" placeholder="Número" name="inscripcionConsularNumero"
                                id="inscripcionConsularNumero">
                        </div>
                        <div class="form-group">
                            <input type="text" placeholder="De Fecha" name="inscripcionConsularFecha"
                                id="inscripcionConsularFecha">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="qr-container" id="qrCode">
            <div>Verificación del QR</div>
        </div>
    </div>

    <!-- Footer fijo con botones de acción -->
    <div class="fixed-footer no-print">
        <button type="button" onclick="generatePDF()">Finalizar y Generar PDF</button>
        <button type="button" onclick="generateOnlyQR()" style="display: none;">Generar solo QR</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.js"></script>
    <script>
        // --- Constantes y Variables Globales ---
        // (countries, provinciasHistoricas, consuladosDataRawISO, etc. - sin cambios)
        const countries = [ /* Full list omitted for brevity - assumed present */
            { code: 'AF', name: 'Afganistán' }, { code: 'AL', name: 'Albania' }, { code: 'DE', name: 'Alemania' },
            { code: 'AD', name: 'Andorra' }, { code: 'AO', name: 'Angola' }, { code: 'AI', name: 'Anguila' },
            { code: 'AQ', name: 'Antártida' }, { code: 'AG', name: 'Antigua y Barbuda' }, { code: 'SA', name: 'Arabia Saudita' },
            { code: 'DZ', name: 'Argelia' }, { code: 'AR', name: 'Argentina' }, { code: 'AM', name: 'Armenia' },
            { code: 'AW', name: 'Aruba' }, { code: 'AU', name: 'Australia' }, { code: 'AT', name: 'Austria' },
            { code: 'AZ', name: 'Azerbaiyán' }, { code: 'BS', name: 'Bahamas' }, { code: 'BD', name: 'Bangladés' },
            { code: 'BB', name: 'Barbados' }, { code: 'BH', name: 'Baréin' }, { code: 'BE', name: 'Bélgica' },
            { code: 'BZ', name: 'Belice' }, { code: 'BJ', name: 'Benín' }, { code: 'BM', name: 'Bermudas' },
            { code: 'BY', name: 'Bielorrusia' }, { code: 'BO', name: 'Bolivia' }, { code: 'BA', name: 'Bosnia y Herzegovina' },
            { code: 'BW', name: 'Botsuana' }, { code: 'BR', name: 'Brasil' }, { code: 'BN', name: 'Brunéi' },
            { code: 'BG', name: 'Bulgaria' }, { code: 'BF', name: 'Burkina Faso' }, { code: 'BI', name: 'Burundi' },
            { code: 'BT', name: 'Bután' }, { code: 'CV', name: 'Cabo Verde' }, { code: 'KH', name: 'Camboya' },
            { code: 'CM', name: 'Camerún' }, { code: 'CA', name: 'Canadá' }, { code: 'TD', name: 'Chad' },
            { code: 'CL', name: 'Chile' }, { code: 'CN', name: 'China' }, { code: 'CY', name: 'Chipre' },
            { code: 'CO', name: 'Colombia' }, { code: 'KM', name: 'Comoras' }, { code: 'CG', name: 'Congo' },
            { code: 'KP', name: 'Corea del Norte' }, { code: 'KR', name: 'Corea del Sur' }, { code: 'CI', name: 'Costa de Marfil' },
            { code: 'CR', name: 'Costa Rica' }, { code: 'HR', name: 'Croacia' }, { code: 'CU', name: 'Cuba' },
            { code: 'CW', name: 'Curazao' }, { code: 'DK', name: 'Dinamarca' }, { code: 'DM', name: 'Dominica' },
            { code: 'EC', name: 'Ecuador' }, { code: 'EG', name: 'Egipto' }, { code: 'SV', name: 'El Salvador' },
            { code: 'AE', name: 'Emiratos Árabes Unidos' }, { code: 'ER', name: 'Eritrea' }, { code: 'SK', name: 'Eslovaquia' },
            { code: 'SI', name: 'Eslovenia' }, { code: 'ES', name: 'España' }, { code: 'US', name: 'Estados Unidos' },
            { code: 'EE', name: 'Estonia' }, { code: 'ET', name: 'Etiopía' }, { code: 'PH', name: 'Filipinas' },
            { code: 'FI', name: 'Finlandia' }, { code: 'FJ', name: 'Fiyi' }, { code: 'FR', name: 'Francia' },
            { code: 'GA', name: 'Gabón' }, { code: 'GM', name: 'Gambia' }, { code: 'GE', name: 'Georgia' },
            { code: 'GH', name: 'Ghana' }, { code: 'GI', name: 'Gibraltar' }, { code: 'GD', name: 'Granada' },
            { code: 'GR', name: 'Grecia' }, { code: 'GL', name: 'Groenlandia' }, { code: 'GP', name: 'Guadalupe' },
            { code: 'GU', name: 'Guam' }, { code: 'GT', name: 'Guatemala' }, { code: 'GF', name: 'Guayana Francesa' },
            { code: 'GG', name: 'Guernsey' }, { code: 'GN', name: 'Guinea' }, { code: 'GQ', name: 'Guinea Ecuatorial' },
            { code: 'GW', name: 'Guinea-Bisáu' }, { code: 'GY', name: 'Guyana' }, { code: 'HT', name: 'Haití' },
            { code: 'HN', name: 'Honduras' }, { code: 'HK', name: 'Hong Kong' }, { code: 'HU', name: 'Hungría' },
            { code: 'IN', name: 'India' }, { code: 'ID', name: 'Indonesia' }, { code: 'IR', name: 'Irán' },
            { code: 'IQ', name: 'Iraq' }, { code: 'IE', name: 'Irlanda' }, { code: 'BV', name: 'Isla Bouvet' },
            { code: 'IM', name: 'Isla de Man' }, { code: 'IS', name: 'Islandia' }, { code: 'KY', name: 'Islas Caimán' },
            { code: 'CK', name: 'Islas Cook' }, { code: 'FO', name: 'Islas Feroe' }, { code: 'GS', name: 'Islas Georgias del Sur y Sandwich del Sur' },
            { code: 'FK', name: 'Islas Malvinas' }, { code: 'MP', name: 'Islas Marianas del Norte' }, { code: 'MH', name: 'Islas Marshall' },
            { code: 'PN', name: 'Islas Pitcairn' }, { code: 'SB', name: 'Islas Salomón' }, { code: 'TC', name: 'Islas Turcas y Caicos' },
            { code: 'VG', name: 'Islas Vírgenes Británicas' }, { code: 'VI', name: 'Islas Vírgenes de los Estados Unidos' }, { code: 'IL', name: 'Israel' },
            { code: 'IT', name: 'Italia' }, { code: 'JM', name: 'Jamaica' }, { code: 'JP', name: 'Japón' },
            { code: 'JE', name: 'Jersey' }, { code: 'JO', name: 'Jordania' }, { code: 'KZ', name: 'Kazajistán' },
            { code: 'KE', name: 'Kenia' }, { code: 'KG', name: 'Kirguistán' }, { code: 'KI', name: 'Kiribati' },
            { code: 'KW', name: 'Kuwait' }, { code: 'LA', name: 'Laos' }, { code: 'LS', name: 'Lesoto' },
            { code: 'LV', name: 'Letonia' }, { code: 'LB', name: 'Líbano' }, { code: 'LR', name: 'Liberia' },
            { code: 'LY', name: 'Libia' }, { code: 'LI', name: 'Liechtenstein' }, { code: 'LT', name: 'Lituania' },
            { code: 'LU', name: 'Luxemburgo' }, { code: 'MO', name: 'Macao' }, { code: 'MK', name: 'Macedonia del Norte' },
            { code: 'MG', name: 'Madagascar' }, { code: 'MY', name: 'Malasia' }, { code: 'MW', name: 'Malaui' },
            { code: 'MV', name: 'Maldivas' }, { code: 'ML', name: 'Malí' }, { code: 'MT', name: 'Malta' },
            { code: 'MA', name: 'Marruecos' }, { code: 'MQ', name: 'Martinica' }, { code: 'MU', name: 'Mauricio' },
            { code: 'MR', name: 'Mauritania' }, { code: 'YT', name: 'Mayotte' }, { code: 'MX', name: 'México' },
            { code: 'FM', name: 'Micronesia' }, { code: 'MD', name: 'Moldavia' }, { code: 'MC', name: 'Mónaco' },
            { code: 'MN', name: 'Mongolia' }, { code: 'ME', name: 'Montenegro' }, { code: 'MS', name: 'Montserrat' },
            { code: 'MZ', name: 'Mozambique' }, { code: 'MM', name: 'Myanmar' }, { code: 'NA', name: 'Namibia' },
            { code: 'NR', name: 'Nauru' }, { code: 'NP', name: 'Nepal' }, { code: 'NI', name: 'Nicaragua' },
            { code: 'NE', name: 'Níger' }, { code: 'NG', name: 'Nigeria' }, { code: 'NU', name: 'Niue' },
            { code: 'NF', name: 'Norfolk' }, { code: 'NO', name: 'Noruega' }, { code: 'NC', name: 'Nueva Caledonia' },
            { code: 'NZ', name: 'Nueva Zelanda' }, { code: 'OM', name: 'Omán' }, { code: 'NL', name: 'Países Bajos' },
            { code: 'PK', name: 'Pakistán' }, { code: 'PW', name: 'Palaos' }, { code: 'PS', name: 'Palestina' },
            { code: 'PA', name: 'Panamá' }, { code: 'PG', name: 'Papúa Nueva Guinea' }, { code: 'PY', name: 'Paraguay' },
            { code: 'PE', name: 'Perú' }, { code: 'PF', name: 'Polinesia Francesa' }, { code: 'PL', name: 'Polonia' },
            { code: 'PT', name: 'Portugal' }, { code: 'PR', name: 'Puerto Rico' }, { code: 'QA', name: 'Qatar' },
            { code: 'GB', name: 'Reino Unido' }, { code: 'CF', name: 'República Centroafricana' }, { code: 'CZ', name: 'República Checa' },
            { code: 'CD', name: 'República Democrática del Congo' }, { code: 'DO', name: 'República Dominicana' }, { code: 'RE', name: 'Reunión' },
            { code: 'RW', name: 'Ruanda' }, { code: 'RO', name: 'Rumania' }, { code: 'RU', name: 'Rusia' },
            { code: 'EH', name: 'Sahara Occidental' }, { code: 'WS', name: 'Samoa' }, { code: 'AS', name: 'Samoa Americana' },
            { code: 'BL', name: 'San Bartolomé' }, { code: 'KN', name: 'San Cristóbal y Nieves' }, { code: 'SM', name: 'San Marino' },
            { code: 'MF', name: 'San Martín' }, { code: 'PM', name: 'San Pedro y Miquelón' }, { code: 'VC', name: 'San Vicente y las Granadinas' },
            { code: 'SH', name: 'Santa Elena' }, { code: 'LC', name: 'Santa Lucía' }, { code: 'ST', name: 'Santo Tomé y Príncipe' },
            { code: 'SN', name: 'Senegal' }, { code: 'RS', name: 'Serbia' }, { code: 'SC', name: 'Seychelles' },
            { code: 'SL', name: 'Sierra Leona' }, { code: 'SG', name: 'Singapur' }, { code: 'SX', name: 'Sint Maarten' },
            { code: 'SY', name: 'Siria' }, { code: 'SO', name: 'Somalia' }, { code: 'LK', name: 'Sri Lanka' },
            { code: 'SZ', name: 'Suazilandia' }, { code: 'ZA', name: 'Sudáfrica' }, { code: 'SD', name: 'Sudán' },
            { code: 'SS', name: 'Sudán del Sur' }, { code: 'SE', name: 'Suecia' }, { code: 'CH', name: 'Suiza' },
            { code: 'SR', name: 'Surinam' }, { code: 'SJ', name: 'Svalbard y Jan Mayen' }, { code: 'TH', name: 'Tailandia' },
            { code: 'TW', name: 'Taiwán' }, { code: 'TZ', name: 'Tanzania' }, { code: 'TJ', name: 'Tayikistán' },
            { code: 'IO', name: 'Territorio Británico del Océano Índico' }, { code: 'TF', name: 'Territorios Australes Franceses' }, { code: 'TL', name: 'Timor Oriental' },
            { code: 'TG', name: 'Togo' }, { code: 'TK', name: 'Tokelau' }, { code: 'TO', name: 'Tonga' },
            { code: 'TT', name: 'Trinidad y Tobago' }, { code: 'TN', name: 'Túnez' }, { code: 'TM', name: 'Turkmenistán' },
            { code: 'TR', name: 'Turquía' }, { code: 'TV', name: 'Tuvalu' }, { code: 'UA', name: 'Ucrania' },
            { code: 'UG', name: 'Uganda' }, { code: 'UY', name: 'Uruguay' }, { code: 'UZ', name: 'Uzbekistán' },
            { code: 'VU', name: 'Vanuatu' }, { code: 'VA', name: 'Vaticano' }, { code: 'VE', name: 'Venezuela' },
            { code: 'VN', name: 'Vietnam' }, { code: 'WF', name: 'Wallis y Futuna' }, { code: 'YE', name: 'Yemen' },
            { code: 'DJ', name: 'Yibuti' }, { code: 'ZM', name: 'Zambia' }, { code: 'ZW', name: 'Zimbabue' }
        ];
        const provinciasHistoricas = { /* Full list omitted for brevity - assumed present */
            before1976: [{ code: '1001', name: 'Pinar del Río', municipios: ['Pinar del Río', 'San Juan y Martínez', 'San Luis', 'Consolación del Sur', 'Los Palacios', 'Viñales'] }, 
                      { code: '1002', name: 'La Habana', municipios: ['La Habana', 'Marianao', 'Regla', 'Guanabacoa', 'Santiago de las Vegas', 'Bauta', 'San Antonio de los Baños'] }, 
                      { code: '674', name: 'Matanzas', municipios: ['Matanzas', 'Cárdenas', 'Colón', 'Jagüey Grande', 'Jovellanos', 'Unión de Reyes'] }, 
                      { code: '1004', name: 'Las Villas', municipios: ['Santa Clara', 'Cienfuegos', 'Sancti Spíritus', 'Trinidad', 'Sagua la Grande', 'Remedios'] }, 
                      { code: '679', name: 'Camagüey', municipios: ['Camagüey', 'Nuevitas', 'Florida', 'Morón', 'Ciego de Ávila'] }, 
                      { code: '1006', name: 'Oriente', municipios: ['Santiago de Cuba', 'Guantánamo', 'Bayamo', 'Holguín', 'Manzanillo', 'Las Tunas'] }],
            after1976: [{ code: '910', name: 'Pinar del Río', municipios: ['Sandino', 'Mantua', 'Minas de Matahambre', 'Viñales', 'La Palma', 'Los Palacios', 'Consolación del Sur', 'Pinar del Río', 'San Luis', 'San Juan y Martínez', 'Guane'] }, 
                     { code: '673', name: 'La Habana', municipios: ['Playa', 'Plaza de la Revolución', 'Centro Habana', 'La Habana Vieja', 'Regla', 'La Habana del Este', 'Guanabacoa', 'San Miguel del Padrón', 'Diez de Octubre', 'Cerro', 'Marianao', 'La Lisa', 'Boyeros', 'Arroyo Naranjo', 'Cotorro'] }, 
                     { code: '674', name: 'Matanzas', municipios: ['Matanzas', 'Cárdenas', 'Varadero', 'Jovellanos', 'Pedro Betancourt', 'Colón', 'Perico', 'Los Arabos', 'Calimete', 'Jagüey Grande', 'Limonar', 'Unión de Reyes', 'Ciénaga de Zapata'] }, 
                     { code: '675', name: 'Villa Clara', municipios: ['Santa Clara', 'Remedios', 'Sagua la Grande', 'Placetas', 'Camajuaní', 'Caibarién', 'Cifuentes', 'Santo Domingo', 'Ranchuelo', 'Manicaragua', 'Quemado de Güines', 'Encrucijada', 'Corralillo'] }, 
                     { code: '676', name: 'Cienfuegos', municipios: ['Cienfuegos', 'Aguada de Pasajeros', 'Rodas', 'Palmira', 'Lajas', 'Cruces', 'Cumanayagua', 'Abreus'] }, 
                     { code: '677', name: 'Sancti Spíritus', municipios: ['Sancti Spíritus', 'Trinidad', 'Cabaiguán', 'Yaguajay', 'Jatibonico', 'Fomento', 'La Sierpe', 'Taguasco'] }, 
                     { code: '678', name: 'Ciego de Ávila', municipios: ['Ciego de Ávila', 'Morón', 'Chambas', 'Venezuela', 'Baraguá', 'Bolivia', 'Primero de Enero', 'Florencia', 'Majagua', 'Ciro Redondo'] }, 
                     { code: '679', name: 'Camagüey', municipios: ['Camagüey', 'Nuevitas', 'Florida', 'Esmeralda', 'Vertientes', 'Santa Cruz del Sur', 'Guáimaro', 'Sibanicú', 'Minas', 'Sierra de Cubitas', 'Najasa', 'Jimaguayú', 'Carlos Manuel de Céspedes'] }, 
                     { code: '680', name: 'Las Tunas', municipios: ['Las Tunas', 'Puerto Padre', 'Jobabo', 'Colombia', 'Manatí', 'Majibacoa', 'Amancio', 'Jesús Menéndez'] }, 
                     { code: '681', name: 'Holguín', municipios: ['Holguín', 'Gibara', 'Rafael Freyre', 'Banes', 'Antilla', 'Báguanos', 'Mayarí', 'Frank País', 'Sagua de Tánamo', 'Moa', 'Calixto García', 'Urbano Noris', 'Cueto', 'Cacocum'] }, 
                     { code: '682', name: 'Granma', municipios: ['Bayamo', 'Manzanillo', 'Yara', 'Campechuela', 'Media Luna', 'Niquero', 'Pilón', 'Bartolomé Masó', 'Jiguaní', 'Buey Arriba', 'Guisa', 'Cauto Cristo', 'Río Cauto'] }, 
                     { code: '683', name: 'Santiago de Cuba', municipios: ['Santiago de Cuba', 'Palma Soriano', 'Contramaestre', 'San Luis', 'Segundo Frente', 'Songo-La Maya', 'Mella', 'Tercer Frente', 'Guamá'] }, 
                     { code: '684', name: 'Guantánamo', municipios: ['Guantánamo', 'Baracoa', 'Maisí', 'San Antonio del Sur', 'Yateras', 'El Salvador', 'Manuel Tames', 'Imías', 'Niceto Pérez', 'Caimanera'] }, 
                     { code: '685', name: 'Isla de la Juventud', municipios: ['Nueva Gerona'] }],
            after2011: [{ code: '910', name: 'Pinar del Río', municipios: ['Sandino', 'Mantua', 'Minas de Matahambre', 'Viñales', 'La Palma', 'Los Palacios', 'Consolación del Sur', 'Pinar del Río', 'San Luis', 'San Juan y Martínez', 'Guane'] }, 
                     { code: '911', name: 'Artemisa', municipios: ['Alquízar', 'Artemisa', 'Bauta', 'Caimito', 'Guanajay', 'Güira de Melena', 'Mariel', 'San Antonio de los Baños', 'Bahía Honda', 'San Cristóbal', 'Candelaria'] }, 
                     { code: '673', name: 'La Habana', municipios: ['Playa', 'Plaza de la Revolución', 'Centro Habana', 'La Habana Vieja', 'Regla', 'Habana del Este', 'Guanabacoa', 'San Miguel del Padrón', 'Diez de Octubre', 'Cerro', 'Marianao', 'La Lisa', 'Boyeros', 'Arroyo Naranjo', 'Cotorro'] }, 
                     { code: '912', name: 'Mayabeque', municipios: ['Bejucal', 'San José de las Lajas', 'Jaruco', 'Santa Cruz del Norte', 'Madruga', 'Nueva Paz', 'San Nicolás', 'Güines', 'Melena del Sur', 'Batabanó', 'Quivicán'] }, 
                     { code: '674', name: 'Matanzas', municipios: ['Matanzas', 'Cárdenas', 'Varadero', 'Jovellanos', 'Pedro Betancourt', 'Colón', 'Perico', 'Los Arabos', 'Calimete', 'Jagüey Grande', 'Limonar', 'Unión de Reyes', 'Ciénaga de Zapata'] }, 
                     { code: '675', name: 'Villa Clara', municipios: ['Santa Clara', 'Remedios', 'Sagua la Grande', 'Placetas', 'Camajuaní', 'Caibarién', 'Cifuentes', 'Santo Domingo', 'Ranchuelo', 'Manicaragua', 'Quemado de Güines', 'Encrucijada', 'Corralillo'] }, 
                     { code: '676', name: 'Cienfuegos', municipios: ['Cienfuegos', 'Aguada de Pasajeros', 'Rodas', 'Palmira', 'Lajas', 'Cruces', 'Cumanayagua', 'Abreus'] }, 
                     { code: '677', name: 'Sancti Spíritus', municipios: ['Sancti Spíritus', 'Trinidad', 'Cabaiguán', 'Yaguajay', 'Jatibonico', 'Fomento', 'La Sierpe', 'Taguasco'] }, 
                     { code: '678', name: 'Ciego de Ávila', municipios: ['Ciego de Ávila', 'Morón', 'Chambas', 'Venezuela', 'Baraguá', 'Bolivia', 'Primero de Enero', 'Florencia', 'Majagua', 'Ciro Redondo'] }, 
                     { code: '679', name: 'Camagüey', municipios: ['Camagüey', 'Nuevitas', 'Florida', 'Esmeralda', 'Vertientes', 'Santa Cruz del Sur', 'Guáimaro', 'Sibanicú', 'Minas', 'Sierra de Cubitas', 'Najasa', 'Jimaguayú', 'Carlos Manuel de Céspedes'] }, 
                     { code: '680', name: 'Las Tunas', municipios: ['Las Tunas', 'Puerto Padre', 'Jobabo', 'Colombia', 'Manatí', 'Majibacoa', 'Amancio', 'Jesús Menéndez'] }, 
                     { code: '681', name: 'Holguín', municipios: ['Holguín', 'Gibara', 'Rafael Freyre', 'Banes', 'Antilla', 'Báguanos', 'Mayarí', 'Frank País', 'Sagua de Tánamo', 'Moa', 'Calixto García', 'Urbano Noris', 'Cueto', 'Cacocum'] }, 
                     { code: '682', name: 'Granma', municipios: ['Bayamo', 'Manzanillo', 'Yara', 'Campechuela', 'Media Luna', 'Niquero', 'Pilón', 'Bartolomé Masó', 'Jiguaní', 'Buey Arriba', 'Guisa', 'Cauto Cristo', 'Río Cauto'] }, 
                     { code: '683', name: 'Santiago de Cuba', municipios: ['Santiago de Cuba', 'Palma Soriano', 'Contramaestre', 'San Luis', 'Segundo Frente', 'Songo-La Maya', 'Mella', 'Tercer Frente', 'Guamá'] }, 
                     { code: '684', name: 'Guantánamo', municipios: ['Guantánamo', 'Baracoa', 'Maisí', 'San Antonio del Sur', 'Yateras', 'El Salvador', 'Manuel Tames', 'Imías', 'Niceto Pérez', 'Caimanera'] }, 
                     { code: '685', name: 'Isla de la Juventud', municipios: ['Nueva Gerona'] }]
        };
        const consuladosDataRawISO = `ISO_CODE,PAÍS,CONSULADO\nUS,ESTADOS UNIDOS,WASHINGTON\nAG,ANTIGUA Y BARBUDA,Saint John\nAR,ARGENTINA,Buenos Aires\nBS,BAHAMAS,NasáBriu\nBB,BARBADOS,Bidgetown\nBZ,BELICE,Balmopán\nBO,BOLIVIA,La Paz\nBO,,Santa Cruz\nBR,BRASIL,Brasilia\nBR,,São Paulo\nCL,CHILE,Santiago de Chile\nCO,COLOMBIA,Bogotá\nCR,COSTA RICA,San José\nDM,DOMINICA,Roseau\nEC,ECUADOR,Quito\nSV,EL SALVADOR,San Salvador\nHT,HAITI,Puerto Príncipe\nHN,HONDURAS,Tegucigalpa\nJM,JAMAICA,Kingston\nGD,GRANADA,Saint George\nGT,GUATEMALA,Ciudad de Guatemala\nGY,GUYANA,Georgetown\nMX,MÉXICO,Cancún\nMX,,Ciudad de México\nMX,,Mérida\nMX,,Monterrey\nMX,,Veracruz\nNI,NICARAGUA,Managua\nPA,PANAMÁ,Panamá\nPY,PARAGUAY,Asunción\nPE,PERÚ,Lima\nDO,REPUBLICA DOMINICANA,Santo Domingo\nKN,SAINT KITTS Y NEVIS,Basseterre\nVC,SAN VICENTE Y LAS GRANADINAS,Kingstown\nLC,SANTA LUCIA,Castries\nSR,SURINAM,Paramaribo\nTT,TRINIDAD TOBAGO,Puerto España\nUY,URUGUAY,Montevideo\nVE,VENEZUELA,Caracas\nDE,Alemania,Berlin\nDE,,Bonn\nAT,Austria,Viena\nAZ,Azerbaiyan,Baku\nBY,Belarus,Minsk\nBE,Belgica,Bruselas\nBG,Bulgaria,Sofia\nCY,Chipre,Nicosia\nDK,Dinamarca,Copenhague\nSK,Eslovaquia,Bratislava\nES,España,Madrid\nES,,Barcelona\nES,,Islas Canarias\nES,,Galicia\nES,,Sevilla\nFI,Finlandia,Helsinki\nFR,Francia,Paris\nGR,Grecia,Atenas\nHU,Hungria,Budapest\nIE,Irlanda,Dublin\nIT,Italia,Roma\nIT,,Milan\nKZ,Kazajstan,Astana\nRU,Rusia,Moscu\nNO,Noruega,Oslo\nNL,Paises Bajos,La Haya\nPL,Polonia,Varsovia\nPT,Portugal,Lisboa\nGB,Reino Unido De Gran Bretaña,Londres\nCZ,Republica Checa,Praga\nRO,Rumania,Bucarest\nRS,Serbia,Belgrado\nCH,Suiza,Berna\nTR,Turquia,Ankara\nTR,,Estambul\nCA,Canada,Montreal\nCA,,Toronto\nCA,,Ottawa\nSA,Arabia Saudita,Arabia Saudita\nDZ,Argelia,Argelia\nEG,Egipto,Egipto\nAE,EAU,EAU\nIR,Irán,Irán\nKW,Kuwait,Kuwait\nLB,Líbano,Líbano\nMA,Marruecos,Marruecos\nQA,Qatar,Qatar\nSY,Siria,Siria\nTN,Túnez,Túnez\nAO,Angola,Angola\nBJ,Benin,Benin\nBW,Bostwana,Bostwana\nBF,Burkina Faso,Burkina Faso\nCV,Cabo Verde,Cabo Verde\nCG,Congo Brazaville,Congo Brazaville\nCD,Congo Kinshasa,Congo Kinshasa\nDJ,Djibouti,Djibouti\nET,Etiopía,Etiopía\nGA,Gabón,Gabón\nGM,Gambia,Gambia\nGH,Ghana,Ghana\nGW,Guinea Bissau,Guinea Bissau`;
        const consuladosPorPaisISO = {}; const todosLosConsuladosISO = new Set(); let paisISOCodeActual = null;
        consuladosDataRawISO.split('\n').slice(1).forEach(line => { line = line.trim(); if (!line) return; const parts = line.split(','); const isoCode = parts[0].trim().toUpperCase(); let consulado = null; if (parts.length >= 3) { consulado = parts[parts.length - 1].trim(); } else if (parts.length === 2 && !isoCode) { consulado = parts[1].trim(); } else if (parts.length === 2 && isoCode) { consulado = parts[1].trim(); } if (isoCode && consulado) { paisISOCodeActual = isoCode; if (!consuladosPorPaisISO[paisISOCodeActual]) { consuladosPorPaisISO[paisISOCodeActual] = []; } consuladosPorPaisISO[paisISOCodeActual].push(consulado); todosLosConsuladosISO.add(consulado); } else if (!isoCode && consulado && paisISOCodeActual) { consuladosPorPaisISO[paisISOCodeActual].push(consulado); todosLosConsuladosISO.add(consulado); } });
        const allConsulatesISOSorted = Array.from(todosLosConsuladosISO).sort((a, b) => a.localeCompare(b));

        // --- Funciones Auxiliares ---
        // (populateSelect, populateCountrySelects, updateConsulados, getYearFromDateString, updateProvinciasMunicipiosByYear, handlePaisNacimientoChange - sin cambios)
        function populateSelect(selectElement, items, placeholder) { if (!selectElement) return; const currentValue = selectElement.value; selectElement.innerHTML = ''; const placeholderOption = document.createElement('option'); placeholderOption.value = ''; placeholderOption.textContent = placeholder; placeholderOption.disabled = true; placeholderOption.selected = true; selectElement.appendChild(placeholderOption); items.forEach(item => { const option = document.createElement('option'); option.value = item.value; option.textContent = item.textContent; selectElement.appendChild(option); }); if (items.some(item => item.value === currentValue)) { selectElement.value = currentValue; } }
        function populateCountrySelects() { const countrySelects = ['paisResidencia', 'paisNacimiento', 'paisResidenciaActual', 'paisTrabajo']; const sortedCountries = countries.sort((a, b) => a.name.localeCompare(b.name)); countrySelects.forEach(selectId => { const select = document.getElementById(selectId); if (select) { populateSelect(select, sortedCountries.map(country => ({ value: country.code, textContent: country.name })), 'Seleccione país'); } }); }
        function updateConsulados() { const paisResidenciaSelect = document.getElementById('paisResidencia'); const consuladoSelect = document.getElementById('consulado'); const selectedCountryCode = paisResidenciaSelect.value; let optionsToShow = []; if (selectedCountryCode && consuladosPorPaisISO[selectedCountryCode]) { optionsToShow = consuladosPorPaisISO[selectedCountryCode].sort((a, b) => a.localeCompare(b)); consuladoSelect.disabled = false; } else if (selectedCountryCode) { optionsToShow = allConsulatesISOSorted; consuladoSelect.disabled = false; } else { consuladoSelect.disabled = true; } populateSelect(consuladoSelect, optionsToShow.map(c => ({ value: c, textContent: c })), 'Seleccione un consulado'); }
        function getYearFromDateString(dateString) { if (!dateString) return null; const date = new Date(dateString); return isNaN(date.getFullYear()) ? null : date.getFullYear(); }
        function updateProvinciasMunicipiosByYear(year) { 
            const provinciaSelect = document.getElementById('provinciaNacimiento'); 
            const municipioSelect = document.getElementById('municipioNacimiento'); 
            let provincias; 
            if (!year) { 
                provincias = []; 
            } else if (year < 1976) { 
                provincias = provinciasHistoricas.before1976; 
            } else if (year < 2011) { 
                provincias = provinciasHistoricas.after1976; 
            } else { 
                provincias = provinciasHistoricas.after2011; 
            } 
            populateSelect(provinciaSelect, provincias.map(p => ({ 
                value: p.code, // Usar código en lugar del nombre formateado
                textContent: p.name 
            })), 'Seleccione provincia'); 
            provinciaSelect.disabled = provincias.length === 0; 
            populateSelect(municipioSelect, [], 'Seleccione municipio'); 
            municipioSelect.disabled = true; 
            provinciaSelect.onchange = function () { 
                const selectedProvinciaData = provincias.find(p => p.code === this.value); 
                if (selectedProvinciaData) { 
                    populateSelect(municipioSelect, selectedProvinciaData.municipios.map(m => ({ 
                        value: m.toLowerCase().replace(/\s+/g, '_'), 
                        textContent: m 
                    })), 'Seleccione municipio'); 
                    municipioSelect.disabled = false; 
                } else { 
                    populateSelect(municipioSelect, [], 'Seleccione municipio'); 
                    municipioSelect.disabled = true; 
                } 
            }; 
            if (provinciaSelect.value) { 
                provinciaSelect.dispatchEvent(new Event('change')); 
            } 
        }
        function handlePaisNacimientoChange() { const paisNacimiento = document.getElementById('paisNacimiento').value; const fechaNacimiento = document.getElementById('fechaNacimiento').value; const provinciaSelect = document.getElementById('provinciaNacimiento'); const municipioSelect = document.getElementById('municipioNacimiento'); const provinciaText = document.getElementById('provinciaNacimientoText'); const municipioText = document.getElementById('municipioNacimientoText'); const provinciaContainer = document.getElementById('provinciaNacimientoContainer'); const municipioContainer = document.getElementById('municipioNacimientoContainer'); provinciaContainer.style.display = 'block'; municipioContainer.style.display = 'block'; if (paisNacimiento === 'CU') { provinciaSelect.style.display = 'block'; municipioSelect.style.display = 'block'; provinciaText.style.display = 'none'; municipioText.style.display = 'none'; provinciaSelect.required = true; municipioSelect.required = true; provinciaText.required = false; municipioText.required = false; const year = getYearFromDateString(fechaNacimiento); updateProvinciasMunicipiosByYear(year); } else { provinciaSelect.style.display = 'none'; municipioSelect.style.display = 'none'; provinciaText.style.display = 'block'; municipioText.style.display = 'block'; provinciaSelect.required = false; municipioSelect.required = false; provinciaText.required = true; municipioText.required = true; provinciaText.disabled = false; municipioText.disabled = false; populateSelect(provinciaSelect, [], 'Seleccione provincia'); populateSelect(municipioSelect, [], 'Seleccione municipio'); provinciaSelect.disabled = true; municipioSelect.disabled = true; } }

        // --- Event Listeners y Población del Formulario ---
        // (DOMContentLoaded - sin cambios significativos)
        document.addEventListener('DOMContentLoaded', function () {
            const fechaSolicitudInput = document.getElementById('fechaSolicitud'); if (fechaSolicitudInput) { const today = new Date().toISOString().split('T')[0]; fechaSolicitudInput.value = today; }
            populateCountrySelects();
            const paisNacimientoSelect = document.getElementById('paisNacimiento'); if (paisNacimientoSelect) { paisNacimientoSelect.value = 'CU'; }
            fetch('https://ipapi.co/json/').then(response => response.ok ? response.json() : Promise.reject('Failed to fetch IP info')).then(data => { if (data && data.country_code) { const paisResidenciaSelect = document.getElementById('paisResidencia'); const paisResidenciaActualSelect = document.getElementById('paisResidenciaActual'); if (paisResidenciaSelect && !paisResidenciaSelect.value) { paisResidenciaSelect.value = data.country_code; paisResidenciaSelect.dispatchEvent(new Event('change')); } if (paisResidenciaActualSelect && !paisResidenciaActualSelect.value) { paisResidenciaActualSelect.value = data.country_code; } } }).catch(error => { console.warn('Could not fetch IP info:', error); updateConsulados(); }).finally(() => { handlePaisNacimientoChange(); updateConsulados(); });
            ['paisResidencia', 'paisNacimiento', 'fechaNacimiento'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('change', () => {
                    if (id === 'paisResidencia') updateConsulados();
                    if (id === 'paisNacimiento' || id === 'fechaNacimiento') handlePaisNacimientoChange();
                });
            });
            const referenceProvinciaSelect = document.getElementById('referenciaProvincia'); 
            const referenciaMunicipioSelect = document.getElementById('referenciaMunicipio'); 
            const currentProvinces = provinciasHistoricas.after2011; 
            populateSelect(referenceProvinciaSelect, currentProvinces.map(p => ({ 
                value: p.code, // Usar código en lugar del nombre formateado
                textContent: p.name 
            })), 'Seleccione provincia'); 
            referenceProvinciaSelect.addEventListener('change', function () { 
                const selectedProvincia = currentProvinces.find(p => p.code === this.value); 
                if (selectedProvincia) { 
                    populateSelect(referenciaMunicipioSelect, selectedProvincia.municipios.map(m => ({ 
                        value: m.toLowerCase().replace(/\s+/g, '_'), 
                        textContent: m 
                    })), 'Seleccione municipio'); 
                    referenciaMunicipioSelect.disabled = false; 
                } else { 
                    populateSelect(referenciaMunicipioSelect, [], 'Seleccione municipio'); 
                    referenciaMunicipioSelect.disabled = true; 
                } 
            });
        });

        // --- Mapeo de Campos ---
        // (fieldMapping - sin cambios)
        const fieldMapping = [{ id: 1, field: 'fechaSolicitud', label: 'Fecha de Solicitud' }, { id: 2, field: 'tramite', label: 'Tipo de Trámite' }, { id: 3, field: 'paisResidencia', label: 'País de Residencia' }, { id: 4, field: 'consulado', label: 'Consulado' }, { id: 5, field: 'numeroPasaporte', label: 'Número de Pasaporte' }, { id: 6, field: 'carneIdentidad', label: 'Carné de Identidad' }, { id: 7, field: 'fechaNacimiento', label: 'Fecha de Nacimiento' }, { id: 8, field: 'sexo', label: 'Sexo' }, { id: 9, field: 'primerApellido', label: 'Primer Apellido' }, { id: 10, field: 'segundoApellido', label: 'Segundo Apellido' }, { id: 11, field: 'primerNombre', label: 'Primer Nombre' }, { id: 12, field: 'segundoNombre', label: 'Segundo Nombre' }, { id: 13, field: 'nombrePadre', label: 'Nombre del Padre' }, { id: 14, field: 'nombreMadre', label: 'Nombre de la Madre' }, { id: 15, field: 'paisNacimiento', label: 'País de Nacimiento' }, { id: 16, field: 'provinciaNacimiento', label: 'Provincia Nacimiento (Cuba)', conditional: (data) => data[15] === 'CU' }, { id: 17, field: 'municipioNacimiento', label: 'Municipio Nacimiento (Cuba)', conditional: (data) => data[15] === 'CU' }, { id: 16.1, field: 'provinciaNacimientoText', label: 'Provincia Nacimiento (Otro)', conditional: (data) => data[15] !== 'CU' }, { id: 17.1, field: 'municipioNacimientoText', label: 'Municipio Nacimiento (Otro)', conditional: (data) => data[15] !== 'CU' }, { id: 18, field: 'colorOjos', label: 'Color de Ojos' }, { id: 19, field: 'colorPiel', label: 'Color de Piel' }, { id: 20, field: 'colorCabello', label: 'Color de Cabello' }, { id: 21, field: 'estatura', label: 'Estatura' }, { id: 22, field: 'estadoCivil', label: 'Estado Civil' }, { id: 23, field: 'diaSalida', label: 'Día de Salida' }, { id: 24, field: 'mesSalida', label: 'Mes de Salida' }, { id: 25, field: 'anoSalida', label: 'Año de Salida' }, { id: 26, field: 'direccionResidencia', label: 'Dirección de Residencia' }, { id: 27, field: 'codigoPostalResidencia', label: 'Código Postal Residencia' }, { id: 28, field: 'provinciaEstadoResidencia', label: 'Provincia/Estado Residencia' }, { id: 29, field: 'paisResidenciaActual', label: 'País de Residencia Actual' }, { id: 30, field: 'telefonoResidencia', label: 'Teléfono Residencia' }, { id: 31, field: 'emailResidencia', label: 'Email Residencia' }, { id: 32, field: 'faxResidencia', label: 'Fax Residencia' }, { id: 33, field: 'nombreCentroTrabajo', label: 'Centro de Trabajo/Estudio' }, { id: 34, field: 'profesionTrabajo', label: 'Profesión' }, { id: 35, field: 'ocupacionTrabajo', label: 'Ocupación' }, { id: 36, field: 'direccionTrabajo', label: 'Dirección Trabajo' }, { id: 37, field: 'codigoPostalTrabajo', label: 'Código Postal Trabajo' }, { id: 38, field: 'provinciaEstadoTrabajo', label: 'Provincia/Estado Trabajo' }, { id: 39, field: 'paisTrabajo', label: 'País Trabajo' }, { id: 40, field: 'telefonoTrabajo', label: 'Teléfono Trabajo' }, { id: 41, field: 'emailTrabajo', label: 'Email Trabajo' }, { id: 42, field: 'faxTrabajo', label: 'Fax Trabajo' }, { id: 43, field: 'nivelCultural', label: 'Nivel Cultural' }, { id: 44, field: 'ocupacionActual', label: 'Ocupación Actual' }, { id: 45, field: 'profesionOficio', label: 'Profesión u Oficio' }, { id: 46, field: 'referenciaNombre', label: 'Nombre Referencia' }, { id: 47, field: 'tipoVinculo', label: 'Tipo de Vínculo' }, { id: 48, field: 'referenciaDireccion', label: 'Dirección Referencia' }, { id: 49, field: 'referenciaProvincia', label: 'Provincia Referencia' }, { id: 50, field: 'referenciaMunicipio', label: 'Municipio Referencia' }, { id: 51, field: 'direccionCuba1', label: 'Dirección Cuba 1' }, { id: 52, field: 'desdeCuba1', label: 'Desde Cuba 1' }, { id: 53, field: 'hastaCuba1', label: 'Hasta Cuba 1' }, { id: 54, field: 'direccionCuba2', label: 'Dirección Cuba 2' }, { id: 55, field: 'desdeCuba2', label: 'Desde Cuba 2' }, { id: 56, field: 'hastaCuba2', label: 'Hasta Cuba 2' }, { id: 57, field: 'pasaporteNumeroVencido', label: 'Número Pasaporte Vencido' }, { id: 58, field: 'pasaporteFechaExpedicionVencido', label: 'Fecha Expedición Pasaporte' }, { id: 59, field: 'pasaporteLugarExpedicionVencido', label: 'Lugar Expedición Pasaporte' }, { id: 60, field: 'certNacimientoTomo', label: 'Tomo Nacimiento' }, { id: 61, field: 'certNacimientoFolio', label: 'Folio Nacimiento' }, { id: 62, field: 'certNacimientoRegistroCivil', label: 'Registro Civil' }, { id: 63, field: 'inscripcionConsularNumero', label: 'Número Inscripción Consular' }, { id: 64, field: 'inscripcionConsularFecha', label: 'Fecha Inscripción Consular' }];

        // --- Generación de PDF y QR ---
        // Función para validar el formulario
        function validateForm() {
            // Obtener todos los campos requeridos
            const requiredFields = document.querySelectorAll('[required]');
            let isValid = true;
            let firstInvalidField = null;
            let errorMessage = '';

            // Limpiar errores previos
            document.querySelectorAll('.error-field').forEach(field => {
                field.classList.remove('error-field');
            });

            // Validar todas las fechas
            const today = new Date();
            const minYear = 1900;

            // Función auxiliar para validar fechas
            function validateDateField(field, fieldName) {
                if (field && field.value) {
                    const date = new Date(field.value);
                    if (isNaN(date.getTime())) {
                        field.classList.add('error-field');
                        isValid = false;
                        errorMessage = `La fecha ${fieldName} no es válida`;
                        if (!firstInvalidField) firstInvalidField = field;
                        return false;
                    }

                    const year = date.getFullYear();
                    if (year < minYear) {
                        field.classList.add('error-field');
                        isValid = false;
                        errorMessage = `La fecha ${fieldName} no puede ser anterior a ${minYear}`;
                        if (!firstInvalidField) firstInvalidField = field;
                        return false;
                    }

                    if (date > today) {
                        field.classList.add('error-field');
                        isValid = false;
                        errorMessage = `La fecha ${fieldName} no puede ser posterior a hoy`;
                        if (!firstInvalidField) firstInvalidField = field;
                        return false;
                    }
                }
                return true;
            }

            // Validar fecha de solicitud
            validateDateField(document.getElementById('fechaSolicitud'), 'de solicitud');

            // Validar fecha de nacimiento
            validateDateField(document.getElementById('fechaNacimiento'), 'de nacimiento');

            // Validar años en la tabla de residencias en Cuba
            const yearFields = ['desdeCuba1', 'hastaCuba1', 'desdeCuba2', 'hastaCuba2'];
            yearFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && field.value) {
                    const year = parseInt(field.value);
                    if (isNaN(year) || year < minYear || year > today.getFullYear()) {
                        field.classList.add('error-field');
                        isValid = false;
                        errorMessage = `El año debe estar entre ${minYear} y ${today.getFullYear()}`;
                        if (!firstInvalidField) firstInvalidField = field;
                    }
                }
            });

            // Validar el carné de identidad si tiene valor
            const carneIdentidad = document.getElementById('carneIdentidad');
            if (carneIdentidad && carneIdentidad.value) {
                const value = carneIdentidad.value;

                if (!/^\d{11}$/.test(value)) {
                    carneIdentidad.classList.add('error-field');
                    isValid = false;
                    errorMessage = 'El carné de identidad debe tener exactamente 11 dígitos';
                    if (!firstInvalidField) firstInvalidField = carneIdentidad;
                } else {
                    // Validar fecha del carné
                    const year = parseInt(value.substring(0, 2));
                    const month = parseInt(value.substring(2, 4));
                    const day = parseInt(value.substring(4, 6));

                    const currentYear = new Date().getFullYear() % 100;
                    const century = year <= currentYear ? 2000 : 1900;
                    const fullYear = century + year;

                    const date = new Date(fullYear, month - 1, day);
                    const isValidDate = date.getMonth() === month - 1 &&
                        date.getDate() === day &&
                        date.getFullYear() === fullYear;

                    if (!isValidDate || fullYear < minYear) {
                        carneIdentidad.classList.add('error-field');
                        isValid = false;
                        errorMessage = 'La fecha en el carné de identidad no es válida o es anterior a 1900';
                        if (!firstInvalidField) firstInvalidField = carneIdentidad;
                    } else {
                        // Verificar que la fecha no sea futura
                        if (date > today) {
                            carneIdentidad.classList.add('error-field');
                            isValid = false;
                            errorMessage = 'La fecha del carné no puede ser futura';
                            if (!firstInvalidField) firstInvalidField = carneIdentidad;
                        }

                        // Verificar edad mínima de 16 años
                        const age = today.getFullYear() - fullYear;
                        if (age < 16 || (age === 16 && today.getMonth() < date.getMonth()) ||
                            (age === 16 && today.getMonth() === date.getMonth() && today.getDate() < date.getDate())) {
                            carneIdentidad.classList.add('error-field');
                            isValid = false;
                            errorMessage = 'La persona debe tener al menos 16 años';
                            if (!firstInvalidField) firstInvalidField = carneIdentidad;
                        }
                    }
                }
            }

            // Validar formato de correos electrónicos
            const emailFields = ['emailResidencia', 'emailTrabajo'];
            const emailPattern = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/;

            emailFields.forEach(fieldId => {
                const emailField = document.getElementById(fieldId);
                if (emailField && emailField.value) {
                    const email = emailField.value.toLowerCase();
                    if (!emailPattern.test(email)) {
                        emailField.classList.add('error-field');
                        isValid = false;
                        errorMessage = 'El formato del correo electrónico no es válido';
                        if (!firstInvalidField) firstInvalidField = emailField;
                    }
                }
            });

            // Validar la fecha de salida de Cuba (día, mes, año)
            const diaSalida = document.getElementById('diaSalida');
            const mesSalida = document.getElementById('mesSalida');
            const anoSalida = document.getElementById('anoSalida');

            if ((diaSalida && diaSalida.value) ||
                (mesSalida && mesSalida.value) ||
                (anoSalida && anoSalida.value)) {

                const dia = parseInt(diaSalida.value) || 1;
                const mes = parseInt(mesSalida.value) || 1;
                const ano = parseInt(anoSalida.value);

                if (ano) {
                    if (ano < minYear || ano > today.getFullYear()) {
                        anoSalida.classList.add('error-field');
                        isValid = false;
                        errorMessage = `El año de salida debe estar entre ${minYear} y ${today.getFullYear()}`;
                        if (!firstInvalidField) firstInvalidField = anoSalida;
                    } else {
                        const fechaSalida = new Date(ano, mes - 1, dia);
                        if (fechaSalida > today) {
                            const campoConError = dia !== 1 ? diaSalida :
                                mes !== 1 ? mesSalida : anoSalida;
                            campoConError.classList.add('error-field');
                            isValid = false;
                            errorMessage = 'La fecha de salida no puede ser posterior a hoy';
                            if (!firstInvalidField) firstInvalidField = campoConError;
                        }
                    }
                }
            }

            // Validar campos requeridos
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('error-field');
                    isValid = false;
                    if (!firstInvalidField) {
                        firstInvalidField = field;
                        errorMessage = 'Por favor, complete todos los campos obligatorios';
                    }
                }
            });

            // Si hay campos inválidos, mostrar mensaje y enfocar el primer campo
            if (!isValid) {
                Toastify({
                    text: errorMessage,
                    duration: 5000,
                    gravity: "top",
                    position: 'right',
                    className: "error"
                }).showToast();

                if (firstInvalidField) {
                    firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstInvalidField.focus();
                }
            }

            return isValid;
        }

        // Función común para generar el código QR
        function generateQR() {
            // Recopilar solo los valores del formulario
            const formValues = [];
            const formElements = document.querySelectorAll('input, select, textarea');
            
            formElements.forEach(element => {
                if (element.id && 
                    element.id !== 'photoInput' && 
                    element.id !== 'signatureInput') {
                    formValues.push(element.value || '');
                }
            });

            // Generar datos para el QR con codificación UTF-8 en formato JSON
            const qrData = JSON.stringify(formValues);
            const encoder = new TextEncoder();
            const decoder = new TextDecoder('utf-8');
            const encodedData = encoder.encode(qrData);
            const utf8Data = decoder.decode(encodedData);

            // Generar el QR con QRious
            const qrContainer = document.getElementById('qrCode');
            qrContainer.innerHTML = '<div>Código de verificación del documento</div><canvas id="qr"></canvas>';

            new QRious({
                element: document.getElementById('qr'),
                value: utf8Data,
                size: 300,
                level: 'M',
                background: 'white',
                foreground: 'black'
            });

            return utf8Data;
        }

        async function generatePDF() {
            if (!validateForm()) return;

            try {
                document.getElementById('loader').style.display = 'flex';

                // Ajustar el tamaño de la fuente para todos los campos de texto
                document.querySelectorAll('input[type="text"], input[type="tel"], input[type="email"], textarea').forEach(input => {
                    const tempSpan = document.createElement('span');
                    tempSpan.style.visibility = 'hidden';
                    tempSpan.style.position = 'absolute';
                    tempSpan.style.whiteSpace = 'nowrap';
                    tempSpan.textContent = input.value;
                    document.body.appendChild(tempSpan);

                    const inputWidth = input.offsetWidth;
                    const textWidth = tempSpan.offsetWidth;

                    document.body.removeChild(tempSpan);

                    if (textWidth > inputWidth) {
                        const ratio = inputWidth / textWidth;
                        const newFontSize = Math.max(8, Math.floor(14 * ratio)); // No permitir tamaño menor a 8px
                        input.style.fontSize = `${newFontSize}px`;
                    }
                });

                // Generar el código QR
                generateQR();

                // Esperar a que se genere el QR
                await new Promise(resolve => setTimeout(resolve, 200));

                // Generar el PDF
                const element = document.getElementById('form-to-print');
                const opt = {
                    margin: [8, 5, 8, 5],
                    filename: 'solicitud_pasaporte.pdf',
                    image: { type: 'jpeg', quality: 0.95 },
                    html2canvas: {
                        scale: 2,
                        useCORS: true,
                        logging: false
                    },
                    jsPDF: {
                        unit: 'mm',
                        format: 'a4',
                        orientation: 'portrait'
                    }
                };

                await html2pdf().from(element).set(opt).save();

                // Restaurar el tamaño de fuente original después de generar el PDF
                document.querySelectorAll('input[type="text"], input[type="tel"], input[type="email"], textarea').forEach(input => {
                    input.style.fontSize = '14px'; // Restaurar al tamaño original
                });

                Toastify({
                    text: "PDF generado exitosamente",
                    duration: 3000,
                    gravity: "top",
                    position: 'right',
                    className: "success"
                }).showToast();

            } catch (error) {
                console.error('Error generando PDF:', error);
                Toastify({
                    text: "Error generando el PDF: " + error.message,
                    duration: 5000,
                    gravity: "top",
                    position: 'right',
                    className: "error"
                }).showToast();
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        // Add continue iteration functionality
        // function continueIteration() {
        //     // Reset form fields but keep the header information
        //     const fieldsToKeep = ['fechaSolicitud', 'tramite', 'paisResidencia', 'consulado'];
        //     const savedValues = {};

        //     // Save values we want to keep
        //     fieldsToKeep.forEach(fieldId => {
        //         const element = document.getElementById(fieldId);
        //         if (element) {
        //             savedValues[fieldId] = element.value;
        //         }
        //     });

        //     // Reset form
        //     document.querySelectorAll('input, select, textarea').forEach(element => {
        //         if (element.type === 'file') {
        //             // Reset file input
        //             element.value = '';
        //             // Reset photo preview if exists
        //             const photoPreview = document.getElementById('uploadedPhoto');
        //             if (photoPreview) {
        //                 photoPreview.style.display = 'none';
        //             }
        //             const photoPlaceholder = document.getElementById('photoPlaceholder');
        //             if (photoPlaceholder) {
        //                 photoPlaceholder.style.display = 'block';
        //             }
        //         } else {
        //             element.value = '';
        //         }
        //     });

        //     // Restore saved values
        //     Object.entries(savedValues).forEach(([fieldId, value]) => {
        //         const element = document.getElementById(fieldId);
        //         if (element) {
        //             element.value = value;
        //         }
        //     });

        //     // Hide the continue button
        //     document.getElementById('continueBtn').style.display = 'none';

        //     // Scroll to top
        //     window.scrollTo(0, 0);

        //     // Show a confirmation message
        //     Toastify({
        //         text: "Form reset for next entry. Header information preserved.",
        //         duration: 3000,
        //         gravity: "top",
        //         position: 'center',
        //         style: {
        //             background: "linear-gradient(135deg, #00C851, #007E33)"
        //         }
        //     }).showToast();
        // }

        // Función para generar solo el QR
        function generateOnlyQR() {
            if (!validateForm()) return;

            try {
                // Generar el código QR
                generateQR();

                // Mostrar mensaje de éxito
                Toastify({
                    text: "Código QR generado exitosamente",
                    duration: 3000,
                    gravity: "top",
                    position: 'right',
                    className: "success"
                }).showToast();

            } catch (error) {
                console.error('Error generando QR:', error);
                Toastify({
                    text: "Error generando el código QR: " + error.message,
                    duration: 5000,
                    gravity: "top",
                    position: 'right',
                    className: "error"
                }).showToast();
            }
        }

        function handlePhotoUpload(input) {
            const file = input.files[0];
            const photoPreview = document.getElementById('uploadedPhoto');
            const photoPlaceholder = document.getElementById('photoPlaceholder');

            if (!file) return;

            // Validación de tipo de archivo
            if (!file.type.startsWith('image/')) {
                showToast('Por favor, seleccione un archivo de imagen válido (JPG o PNG)', 'error');
                input.value = '';
                return;
            }

            // Validación de tamaño (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('La imagen no debe exceder 5MB', 'error');
                input.value = '';
                return;
            }

            const img = new Image();
            img.onload = function () {
                // Validar dimensiones (proporción aproximada 4:4.5)
                const aspectRatio = this.width / this.height;
                const expectedRatio = 4 / 4.5;
                const tolerance = 0.2; // 20% de tolerancia

                if (Math.abs(aspectRatio - expectedRatio) > tolerance) {
                    showToast('La imagen debe tener una proporción aproximada de 4:4.5 cm', 'error');
                    input.value = '';
                    photoPreview.style.display = 'none';
                    photoPlaceholder.style.display = 'block';
                    return;
                }

                // Mostrar la imagen
                photoPreview.src = URL.createObjectURL(file);
                photoPreview.style.display = 'block';
                photoPlaceholder.style.display = 'none';
            };

            img.onerror = function () {
                showToast('Error al cargar la imagen. Por favor, intente con otra.', 'error');
                input.value = '';
            };

            img.src = URL.createObjectURL(file);
        }

        function showToast(message, type = 'error') {
            Toastify({
                text: message,
                duration: 3000,
                gravity: "top",
                position: "center",
                className: type,
                style: {
                    background: type === 'error' ? "linear-gradient(to right, #ff4444, #cc0000)" :
                        "linear-gradient(to right, #00C851, #007E33)"
                }
            }).showToast();
        }
    </script>
</body>

</html>