<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitud de Tramites Consulares</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
        /* Estilos generales (sin cambios significativos respecto a la versión anterior) */
        body {
            font-family: Arial, sans-serif;
            line-height: 1.4;
            margin: 0;
            padding: 15px;
            color: #333;
            background-color: #f4f4f4;
            position: relative;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 70px;
            /* Espacio para el footer */
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background-image: url('img/escudo_cuba_lineas_azul.png');
            background-position: center 15px;
            background-repeat: no-repeat;
            opacity: 0.1;
            z-index: -1;
            pointer-events: none;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            margin: 3px 0;
            font-size: 22px;
        }

        .header h2 {
            margin: 3px 0;
            font-size: 16px;
            font-weight: normal;
            color: #777;
        }

        .form-section {
            margin-bottom: 15px;
            border: 1px solid rgba(221, 221, 221, 0.6);
            padding: 15px;
            border-radius: 6px;
            background-color: rgba(255, 255, 255, 0);
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .form-title {
            background-color: rgba(224, 224, 224, 0.9);
            color: #333;
            padding: 8px 12px;
            margin: -15px -15px 15px -15px;
            border-bottom: 1px solid rgba(204, 204, 204, 0.6);
            font-weight: bold;
            font-size: 16px;
            border-radius: 6px 6px 0 0;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
            align-items: flex-start;
        }

        .form-group {
            flex: 1;
            min-width: 140px;
        }

        .form-group.width-auto {
            flex: 0 1 auto;
            min-width: auto;
        }

        .form-group.width-small {
            flex: 0 1 90px;
            min-width: 70px;
        }

        .form-group.width-medium {
            flex: 0 1 160px;
            min-width: 140px;
        }

        .form-group.width-large {
            flex: 1 1 230px;
            min-width: 180px;
        }

        .form-group.full-width {
            flex: 1 1 100%;
            min-width: 100%;
        }

        label {
            display: block;
            margin-bottom: 3px;
            font-weight: bold;
            font-size: 13px;
            color: #555;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 14px;
        }

        input[type="text"],
        input[type="tel"],
        textarea {
            text-transform: uppercase;
        }

        input[type="email"] {
            text-transform: lowercase;
        }

        input[type="number"] {
            -webkit-appearance: none;
            -moz-appearance: textfield;
            appearance: textfield;
            margin: 0;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        select:disabled,
        input:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
            opacity: 0.7;
        }

        input[type="date"] {
            padding: 7px;
            font-size: 14px;
        }

        .photo-box {
            border: 2px dashed #bbb;
            width: 160px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            color: #777;
            font-size: 13px;
            box-sizing: border-box;
        }

        .signature-box {
            border: 1px solid #999;
            width: 100%;
            height: 200px;
            margin-top: 3px;
            background-color: #fff;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-style: italic;
            box-sizing: border-box;
        }

        .qr-container {
            margin: 20px auto;
            text-align: center;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            display: block;
            width: fit-content;
            border-radius: 5px;
        }

        #qrCode>div {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 13px;
        }

        #qrCode canvas,
        #qrCode img {
            max-width: 100%;
            height: auto;
        }

        .btn-container {
            text-align: center;
            margin: 15px 0;
        }

        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            margin: 5px;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:hover:enabled {
            background-color: #0056b3;
        }

        .residence-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 13px;
        }

        .residence-table th,
        .residence-table td {
            border: 1px solid #ddd;
            padding: 5px;
            text-align: left;
        }

        .residence-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        .residence-table td:first-child {
            width: 60%;
        }

        .residence-table td:nth-child(2),
        .residence-table td:nth-child(3) {
            width: 20%;
        }

        .residence-table input[type="text"] {
            border: none;
            padding: 3px;
            font-size: 13px;
        }

        .residence-table input[type="number"] {
            border: none;
            padding: 3px;
            font-size: 13px;
            width: 100%;
            -moz-appearance: textfield;
            appearance: textfield;
        }

        .declaration {
            font-style: italic;
            margin: 15px 0;
            padding: 10px;
            background-color: #f9f9f9;
            border-left: 4px solid #ccc;
            border-radius: 4px;
            color: #555;
            font-size: 13px;
        }

        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 15px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error-field {
            border: 2px solid #ff4444 !important;
            background-color: #fff3f3 !important;
        }

        /* --- Print-specific styles --- */
        @media print {
            body {
                background-color: #fff;
                padding: 0;
                font-size: 8.5pt;
                /* Further reduced base font size */
                line-height: 1.25;
                /* Further reduced line-height */
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;

            }

            #form-to-print {
                max-width: 100%;
                padding: 5mm;
                box-shadow: none;
                border-radius: 0;
                border: none;
                /* Remove border for print */
            }

            .form-section {
                border: 1px solid #ccc;
                box-shadow: none;
                margin-bottom: 6px;
                /* Further reduced margin */
                padding: 6px;
                /* Further reduced padding */
                page-break-inside: avoid;
                /* Keep avoid on sections */
            }

            .form-title {
                margin: -6px -6px 6px -6px;
                /* Adjust title margin */
                padding: 4px 6px;
                /* Reduced padding */
                font-size: 10pt;
                /* Further reduced font size */
            }

            .form-row {
                margin-bottom: 5px;
                /* Further reduced margin */
                gap: 5px;
                /* Further reduced gap */
            }

            label {
                font-size: 8.5pt;
                /* Match body font size */
                margin-bottom: 1px;
                /* Further reduced margin */
            }

            input,
            select,
            textarea {
                font-size: 8.5pt;
                /* Match body font size */
                padding: 3px;
                /* Further reduced padding */
                border-radius: 2px;
                /* Smaller radius */
                border: 1px solid #bbb;
                /* Lighter border */
            }

            input[type="date"] {
                padding: 2px;
            }

            .photo-box {
                width: 35mm;
                height: 45mm;
                font-size: 7pt;
                padding: 4px;
                margin-bottom: 4px;
                border-style: solid;
                border-width: 1px;
                border-color: #ccc;
                /* Solid border for print */
            }

            .signature-box {
                height: 18mm;
                /* Slightly reduced */
                margin-top: 1px;
                border: 1px solid #aaa;
            }

            .residence-table {
                font-size: 7.5pt;
                /* Further reduced */
                margin: 4px 0;
            }

            .residence-table th,
            .residence-table td {
                padding: 2px;
                /* Further reduced padding */
            }

            .residence-table input {
                padding: 1px;
                font-size: 7.5pt;
            }

            .declaration {
                font-size: 7.5pt;
                padding: 4px;
                margin: 6px 0;
                border-left-width: 3px;
            }

            .qr-container {
                page-break-inside: avoid;
                margin: 8px auto;
                padding: 4px;
                border: 1px solid #aaa;
            }

            #qrCode>div {
                font-size: 7pt;
                margin-bottom: 2px;
            }

            #qrCode canvas,
            #qrCode img {
                max-width: 35mm;
            }

            /* Reduced QR size */

            .no-print,
            .no-print * {
                /* Aplica a todos los hijos */
                display: none !important;
            }

            /* Removed page-break-inside: avoid from form-group and date-input-group */

        }

        /* Container for date inputs */
        .date-input-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .date-input-group input[type="number"] {
            width: 60px;
            flex: 0 0 auto;
        }

        .date-input-group input::placeholder {
            font-size: 11px;
            color: #999;
        }

        /* Main form container */
        #form-to-print {
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
            box-sizing: border-box;
            position: relative;
            /* background-color: #fff;  */
            /* box-shadow: 0 0 10px rgba(0,0,0,0.1); */
            border-radius: 6px;
        }

        /* Toastify notification styling */
        .toastify {
            font-family: Arial, sans-serif;
            padding: 10px 18px;
            color: #ffffff;
            border-radius: 4px;
            font-size: 13px;
            z-index: 1001;
        }

        .toastify.error {
            background: linear-gradient(135deg, #ff4444, #cc0000);
        }

        .toastify.success {
            background: linear-gradient(135deg, #00C851, #007E33);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            #form-to-print {
                padding: 10px;
            }

            .form-row {
                flex-direction: column;
                gap: 5px;
                /* Reducido de 8px a 5px */
                margin-bottom: 5px;
                /* Añadido para reducir espacio vertical */
            }

            .form-group {
                min-width: 100%;
                width: 100%;
                margin-bottom: 5px;
                /* Añadido para reducir espacio vertical */
            }

            .form-section {
                margin-bottom: 10px;
                /* Reducido el margen inferior */
                padding: 10px;
                /* Reducido el padding */
            }

            .date-input-group {
                flex-wrap: wrap;
                gap: 5px;
            }

            .date-input-group input[type="number"] {
                width: calc(33% - 4px);
            }

            /* .photo-box { width: 140px; height: 170px; } */
            .header h1 {
                font-size: 18px;
            }

            .header h2 {
                font-size: 15px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            #form-to-print {
                padding: 8px;
            }

            .form-row {
                gap: 3px;
                /* Reducido aún más para pantallas muy pequeñas */
                margin-bottom: 3px;
                /* Reducido aún más para pantallas muy pequeñas */
            }

            .form-group {
                margin-bottom: 3px;
                /* Reducido aún más para pantallas muy pequeñas */
            }

            .header h1 {
                font-size: 16px;
            }

            .header h2 {
                font-size: 13px;
            }

            button {
                font-size: 14px;
                padding: 8px 15px;
            }

            .date-input-group input[type="number"] {
                width: calc(33% - 4px);
            }

            /* .photo-box { width: 110px; height: 140px; } */
            label {
                font-size: 12px;
            }

            input,
            select,
            textarea {
                font-size: 13px;
                padding: 6px;
                margin-bottom: 2px;
                /* Añadido para reducir espacio vertical */
            }
        }

        /* Estilo para el footer fijo */
        .fixed-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #f8f9fa;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            padding: 10px 0;
            text-align: center;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            border-top: 1px solid #ddd;
        }

        .fixed-footer button {
            margin: 0 10px;
        }

        @media print {
            .fixed-footer {
                display: none !important;
            }
        }

        /* Media queries responsivas para el footer */
        @media (max-width: 768px) {
            body {
                padding-bottom: 60px;
            }

            .fixed-footer {
                padding: 8px 0;
            }

            .fixed-footer button {
                padding: 8px 15px;
                font-size: 14px;
                margin: 0 5px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding-bottom: 50px;
            }

            .fixed-footer {
                padding: 6px 0;
            }

            .fixed-footer button {
                padding: 6px 12px;
                font-size: 13px;
                margin: 0 3px;
            }
        }
    </style>
</head>

<body>
    <div id="loader">
        <div style="background: white; padding: 30px; border-radius: 8px; text-align: center;">
            <p style="font-size: 18px; margin-bottom: 15px;">Generando PDF, por favor espere...</p>
            <div class="spinner"></div>
        </div>
    </div>

    <div id="form-to-print">
        <div class="header">
            <h1>SOLICITUD DE TRÁMITES CONSULARES</h1>
            <h2>REPÚBLICA DE CUBA</h2>
        </div>

        <div class="form-section">
            <div class="form-title">DATOS INICIALES</div>
            <div class="form-row">
                <div class="form-group">
                    <label for="fechaSolicitud">Fecha de Solicitud</label>
                    <input type="date" id="fechaSolicitud" name="fechaSolicitud" required>
                </div>
                <div class="form-group">
                    <label for="tramite">Tipo de Trámite:</label>
                    <select id="tramite" name="tramite" required>
                        <option value="">Seleccione</option>
                        <option value="primera_vez">Pasaporte primera Vez</option>
                        <option value="renovacion">Pasaporte Renovación</option>
                        <option value="ccv">CCV</option>
                        <option value="pe-1">H-1</option>
                    </select>
                </div>
            </div>
            <!-- </div>

        <div class="form-section">  -->

            <div class="form-row">
                <hr>
                <div class="form-group" style="flex: 1;">
                    <label>Foto del Solicitante</label>
                    <div class="photo-box" id="photoPreviewContainer">
                        <input type="file" id="photoInput" accept="image/*" style="display: none;"
                            onchange="handlePhotoUpload(this)">
                        <div id="photoPreview">
                            <div id="photoPlaceholder">
                                FOTO<br>(4 x 4.5 cm)<br>
                                <small style="font-size: 11px;">
                                    - Fondo blanco<br>
                                    - Rostro centrado<br>
                                    - Sin lentes ni accesorios<br>
                                    - Formato JPG/PNG
                                </small>
                            </div>
                            <img id="uploadedPhoto"
                                style="display: none; max-width: 100%; max-height: 100%; object-fit: contain;">
                        </div>
                    </div>
                    <div class="no-print" style="text-align: center; width: 150px;">
                        <button type="button" onclick="document.getElementById('photoInput').click()" style="background-color: #007bff; color: white; border: none; width: 100%;
                                       padding: 5px; border-radius: 3px; font-size: 12px; cursor: pointer;">
                            Subir Foto
                        </button>
                    </div>
                </div>
                <div class="form-group" style="flex: 2;">
                    <label>Firma del Solicitante</label>
                    <div class="signature-box">
                        Firmar dentro de este espacio
                    </div>
                </div>
            </div>
            <!-- </div>

        <div class="form-section"> -->
            <br>

            <div class="form-title">DATOS GENERALES</div>
            <div class="form-row">
                <div class="form-group"> <label for="paisResidencia">País de Residencia</label>
                    <select id="paisResidencia" name="paisResidencia" required>
                        <option value="">Seleccione</option>
                    </select>
                </div>
                <div class="form-group"> <label for="consulado">Consulado</label>
                    <select id="consulado" name="consulado" required disabled>
                        <option value="">Seleccione un consulado</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group"> <label for="numeroPasaporte">Número de Pasaporte</label>
                    <input type="text" id="numeroPasaporte" name="numeroPasaporte" required>
                </div>
                <div class="form-group"> <label for="carneIdentidad">Carné de Identidad</label>
                    <input type="text" id="carneIdentidad" name="carneIdentidad" pattern="[0-9]{11}"
                        oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 11)"
                        onblur="validateCubanID(this)"
                        title="Debe contener 11 dígitos y ser un carné de identidad válido">
                </div>
                <div class="form-group">
                    <label for="fechaNacimiento">Fecha de Nacimiento</label>
                    <input type="date" id="fechaNacimiento" name="fechaNacimiento" required>
                </div>
                <div class="form-group"> <label for="sexo">Sexo</label>
                    <select id="sexo" name="sexo" required>
                        <option value="">Seleccione</option>
                        <option value="masculino">M</option>
                        <option value="femenino">F</option>
                    </select>
                </div>

            </div>
            <div class="form-row">
                <div class="form-group" style="flex: 1;"> <label for="primerApellido">Primer Apellido</label>
                    <input type="text" id="primerApellido" name="primerApellido" required>
                </div>
                <div class="form-group" style="flex: 1;"> <label for="segundoApellido">Segundo Apellido</label>
                    <input type="text" id="segundoApellido" name="segundoApellido">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group" style="flex: 1;"> <label for="primerNombre">Primer Nombre</label>
                    <input type="text" id="primerNombre" name="primerNombre" required>
                </div>
                <div class="form-group" style="flex: 1;"> <label for="segundoNombre">Segundo Nombre</label>
                    <input type="text" id="segundoNombre" name="segundoNombre">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="nombrePadre">Hijo de: Padre</label>
                    <input type="text" id="nombrePadre" name="nombrePadre">
                </div>
                <div class="form-group">
                    <label for="nombreMadre">y Madre</label>
                    <input type="text" id="nombreMadre" name="nombreMadre">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="paisNacimiento">País de Nacimiento</label>
                    <select id="paisNacimiento" name="paisNacimiento" required>
                        <option value="">Seleccione</option>
                    </select>
                </div>
                <div class="form-group" id="provinciaNacimientoContainer">
                    <label for="provinciaNacimiento">Provincia de Nacimiento</label>
                    <select id="provinciaNacimiento" name="provinciaNacimiento" required disabled>
                        <option value="">Seleccione país y año</option>
                    </select>
                    <input type="text" id="provinciaNacimientoText" name="provinciaNacimientoText"
                        style="display: none;">
                </div>
                <div class="form-group" id="municipioNacimientoContainer">
                    <label for="municipioNacimiento">Municipio de Nacimiento</label>
                    <select id="municipioNacimiento" name="municipioNacimiento" required disabled>
                        <option value="">Seleccione provincia</option>
                    </select>
                    <input type="text" id="municipioNacimientoText" name="municipioNacimientoText"
                        style="display: none;">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="colorOjos">Color de Ojos</label>
                    <select id="colorOjos" name="colorOjos">
                        <option value="">Seleccione</option>
                        <option value="6">NEGROS</option>
                        <option value="7">AZULES</option>
                        <option value="512">PARDOS</option>
                        <option value="513">VERDES</option>
                        <option value="514">CLAROS</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="colorPiel">Color de Piel</label>
                    <select id="colorPiel" name="colorPiel">
                        <option value="">Seleccione</option>
                        <option value="3">BLANCA</option>
                        <option value="4">NEGRA</option>
                        <option value="5">MESTIZA</option>
                        <option value="203">ALBINA</option>
                        <option value="204">AMARILLA</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="colorCabello">Color de Cabello</label>
                    <select id="colorCabello" name="colorCabello">
                        <option value="">Seleccione</option>
                        <option value="12">NEGRO</option>
                        <option value="13">RUBIO</option>
                        <option value="14">ROJO</option>
                        <option value="15">CASTAÑO</option>
                        <option value="17">CAOBA</option>
                        <option value="18">OTRO</option>
                        <option value="205">CANOSO</option>
                    </select>
                </div>
            </div>

            <div class="form-row">

                <div class="form-group width-small"> <label for="estatura">Estatura (cm)</label>
                    <input type="number" id="estatura" name="estatura" min="100" max="250">
                </div>
                <div class="form-group"> <label for="estadoCivil">Estado Civil</label>
                    <select id="estadoCivil" name="estadoCivil">
                        <option value="">Seleccione</option>
                        <option value="21">CASADO</option>
                        <option value="22">SOLTERO</option>
                        <option value="504">DIVORCIADO</option>
                        <option value="505">VIUDO</option>
                        <option value="506">SEPARADO</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Fecha de salida de Cuba</label>
                    <div class="date-input-group">
                        <input type="number" id="diaSalida" name="diaSalida" placeholder="Día" min="1" max="31">
                        <input type="number" id="mesSalida" name="mesSalida" placeholder="Mes" min="1" max="12">
                        <input type="number" id="anoSalida" name="anoSalida" placeholder="Año" min="1900" max="2100">
                    </div>
                </div>
            </div>


            <!-- </div>

        <div class="form-section"> -->
            <br>
            <br>

            <div class="form-title">LUGAR DE RESIDENCIA ACTUAL</div>
            <div class="form-row">
                <div class="form-group" style="flex-basis: 60%;">
                    <label for="direccionResidencia">Dirección (calle, Ave. Nro. Entre Calles)</label>
                    <input type="text" id="direccionResidencia" name="direccionResidencia" required>
                </div>
                <div class="form-group" style="flex-basis: 35%;"> <label for="codigoPostalResidencia">Código
                        Postal</label>
                    <input type="text" id="codigoPostalResidencia" name="codigoPostalResidencia">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="provinciaEstadoResidencia">Provincia - Estado - Región</label>
                    <input type="text" id="provinciaEstadoResidencia" name="provinciaEstadoResidencia" required>
                </div>
                <div class="form-group">
                    <label for="paisResidenciaActual">País</label>
                    <select id="paisResidenciaActual" name="paisResidenciaActual" required></select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="telefonoResidencia">Teléfono</label>
                    <input type="tel" id="telefonoResidencia" name="telefonoResidencia" required>
                </div>
                <div class="form-group">
                    <label for="emailResidencia">E-Mail</label>
                    <input type="email" id="emailResidencia" name="emailResidencia" required
                        oninput="this.value = this.value.toLowerCase()" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                        title="Por favor introduzca una dirección de correo válida">
                </div>
                <div class="form-group">
                    <label for="faxResidencia">Fax</label>
                    <input type="tel" id="faxResidencia" name="faxResidencia">
                </div>
            </div>
            <!-- </div>

        <div class="form-section"> -->
            <br>
            <br>

            <div class="form-title">DATOS LABORALES O DE ESTUDIO</div>
            <div class="form-row">
                <div class="form-group full-width">
                    <label for="nombreCentroTrabajo">Nombre del Centro de Trabajo/Estudio</label>
                    <input type="text" id="nombreCentroTrabajo" name="nombreCentroTrabajo">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="nivelCultural">Nivel Cultural</label>
                    <select id="nivelCultural" name="nivelCultural" required>
                        <option value="">Seleccione</option>
                        <option value="23">UNIVERSITARIO</option>
                        <option value="25">TEC. MEDIO</option>
                        <option value="508">PRIMARIO</option>
                        <option value="509">SECUNDARIO</option>
                        <option value="510">PRE-UNIVERSITARIO</option>
                        <option value="511">ANALFABETO</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="profesionTrabajo">Profesión</label>
                    <select id="profesionTrabajo" name="profesionTrabajo" required>
                        <option value="">Seleccione una profesión</option>
                        <option value="861">Abogado</option>
                        <option value="862">Ama de Casa</option>
                        <option value="863">Artista</option>
                        <option value="864">Campesino</option>
                        <option value="865">Científico</option>
                        <option value="866">Comerciante</option>
                        <option value="867">Deportista</option>
                        <option value="868">Diplomático</option>
                        <option value="869">Empleado</option>
                        <option value="870">Empresario</option>
                        <option value="871">Enfermera</option>
                        <option value="872">Escritor</option>
                        <option value="873">Estudiante</option>
                        <option value="874">Funcionario</option>
                        <option value="875">Informático Superior</option>
                        <option value="876">Informático Técnico</option>
                        <option value="877">Ingeniero</option>
                        <option value="878">Intelectual</option>
                        <option value="879">Licenciado</option>
                        <option value="880">Maestro</option>
                        <option value="881">Médico</option>
                        <option value="882">Obrero</option>
                        <option value="883">Periodista</option>
                        <option value="884">Político</option>
                        <option value="885">Profesor</option>
                        <option value="886">Religioso</option>
                        <option value="887">Técnico</option>
                        <option value="1952">Otra</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="ocupacionTrabajo">Ocupación</label>
                    <input type="text" id="ocupacionTrabajo" name="ocupacionTrabajo">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group full-width">
                    <label for="direccionTrabajo">Dirección (calle, Ave., Nro., Entre Calles)</label>
                    <input type="text" id="direccionTrabajo" name="direccionTrabajo">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="codigoPostalTrabajo">Código Postal</label>
                    <input type="text" id="codigoPostalTrabajo" name="codigoPostalTrabajo">
                </div>
                <div class="form-group">
                    <label for="provinciaEstadoTrabajo">Provincia - Estado - Región</label>
                    <input type="text" id="provinciaEstadoTrabajo" name="provinciaEstadoTrabajo">
                </div>
                <div class="form-group">
                    <label for="paisTrabajo">País</label>
                    <select id="paisTrabajo" name="paisTrabajo"></select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="telefonoTrabajo">Teléfono</label>
                    <input type="tel" id="telefonoTrabajo" name="telefonoTrabajo">
                </div>
                <div class="form-group">
                    <label for="emailTrabajo">E-Mail</label>
                    <input type="email" id="emailTrabajo" name="emailTrabajo"
                        oninput="this.value = this.value.toLowerCase()" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                        title="Por favor introduzca una dirección de correo válida">
                </div>
                <div class="form-group">
                    <label for="faxTrabajo">Fax</label>
                    <input type="tel" id="faxTrabajo" name="faxTrabajo">
                </div>
            </div>
            <!-- </div>

        <div class="form-section"> -->
            <br>
            <br>
            <div class="form-title">INFORMACIÓN ADICIONAL</div>
            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label for="referenciaNombre">Nombre y Apellidos de la Referencia en Cuba</label>
                    <input type="text" id="referenciaNombre" name="referenciaNombre">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="tipoVinculo">Tipo de vínculo</label>
                    <select id="tipoVinculo" name="tipoVinculo">
                        <option value="">Seleccione</option>
                        <option value="280">ESPOSO(A)</option>
                        <option value="281">ABUELO(A)</option>
                        <option value="282">VECINO(A)</option>
                        <option value="283">REPRESENTANTE LEGAL</option>
                        <option value="284">PADRE</option>
                        <option value="285">MADRE</option>
                        <option value="286">HERMANO(A)</option>
                        <option value="287">TRABAJADOR SOCIAL</option>
                        <option value="288">PRIMO(A)</option>
                        <option value="289">TIO(A)</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label for="referenciaDireccion">Dirección de la Referencia</label>
                    <input type="text" id="referenciaDireccion" name="referenciaDireccion">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="referenciaProvincia">Provincia</label>
                    <select id="referenciaProvincia" name="referenciaProvincia">
                        <option value="">Seleccione provincia</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="referenciaMunicipio">Municipio</label>
                    <select id="referenciaMunicipio" name="referenciaMunicipio" disabled>
                        <option value="">Seleccione municipio</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group full-width">
                    <label>Lugar de Residencia en Cuba (dos últimas direcciones)</label>
                    <table class="residence-table">
                        <thead>
                            <tr>
                                <th>Dirección</th>
                                <th>Desde</th>
                                <th>Hasta</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input type="text" style="width: 100%;" name="direccionCuba1" id="direccionCuba1">
                                </td>
                                <td><input type="number" style="width: 100%;" name="desdeCuba1" id="desdeCuba1"
                                        min="1900" max="2025" placeholder="AAAA"></td>
                                <td><input type="number" style="width: 100%;" name="hastaCuba1" id="hastaCuba1"
                                        min="1900" max="2025" placeholder="AAAA"></td>
                            </tr>
                            <tr>
                                <td><input type="text" style="width: 100%;" name="direccionCuba2" id="direccionCuba2">
                                </td>
                                <td><input type="number" style="width: 100%;" name="desdeCuba2" id="desdeCuba2"
                                        min="1900" max="2025" placeholder="AAAA"></td>
                                <td><input type="number" style="width: 100%;" name="hastaCuba2" id="hastaCuba2"
                                        min="1900" max="2025" placeholder="AAAA"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- </div>

        <div class="form-section"> -->
            <br>
            <br>
            <div class="form-title">DOCUMENTOS</div>
            <div class="form-row">
                <div class="form-group full-width">
                    <label>Pasaporte vencido</label>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" placeholder="Número" name="pasaporteNumeroVencido"
                                id="pasaporteNumeroVencido">
                        </div>
                        <div class="form-group">
                            <input type="text" placeholder="Fecha expedición" name="pasaporteFechaExpedicionVencido"
                                id="pasaporteFechaExpedicionVencido">
                        </div>
                        <div class="form-group">
                            <input type="text" placeholder="Lugar" name="pasaporteLugarExpedicionVencido"
                                id="pasaporteLugarExpedicionVencido">
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group full-width">
                    <label>Certificación de Nacimiento</label>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" placeholder="Tomo" name="certNacimientoTomo" id="certNacimientoTomo">
                        </div>
                        <div class="form-group">
                            <input type="text" placeholder="Folio" name="certNacimientoFolio" id="certNacimientoFolio">
                        </div>
                        <div class="form-group">
                            <input type="text" placeholder="Registro Civil" name="certNacimientoRegistroCivil"
                                id="certNacimientoRegistroCivil">
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group full-width">
                    <label>Inscripción Consular</label>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" placeholder="Número" name="inscripcionConsularNumero"
                                id="inscripcionConsularNumero">
                        </div>
                        <div class="form-group">
                            <input type="text" placeholder="De Fecha" name="inscripcionConsularFecha"
                                id="inscripcionConsularFecha">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="qr-container" id="qrCode">
            <div>Verificación del QR</div>
        </div>
    </div>

    <!-- Footer fijo con botones de acción -->
    <div class="fixed-footer no-print">
        <button type="button" onclick="generatePDF()">Finalizar y Generar PDF</button>
        <button type="button" onclick="generateOnlyQR()" style="display: none;">Generar solo QR</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.js"></script>
    <script>
        // --- Constantes y Variables Globales ---
        // (countries, provinciasHistoricas, consuladosDataRawISO, etc. - sin cambios)
        const countries = [
            { code: '1', name: 'CUBA' },
            { code: '5', name: 'GUAYANA FRANCESA' },
            { code: '6', name: 'GUINEA' },
            { code: '7', name: 'GUINEA-BISSAU' },
            { code: '8', name: 'GUINEA ECUATORIAL' },
            { code: '9', name: 'GUYANA' },
            { code: '10', name: 'HAITI' },
            { code: '11', name: 'HONDURAS' },
            { code: '12', name: 'HONG-KONG, REGION ADMINISTRATIVA ESPECIAL DE CHINA' },
            { code: '13', name: 'HUNGRIA' },
            { code: '14', name: 'INDIA' },
            { code: '15', name: 'INDONESIA' },
            { code: '16', name: 'IRAN (REPUBLICA ISLAMICA DEL)' },
            { code: '17', name: 'IRAQ' },
            { code: '18', name: 'IRLANDA' },
            { code: '19', name: 'ISLA BOUVET' },
            { code: '20', name: 'ISLA CHRISTMAS' },
            { code: '21', name: 'ISLA NORFOLK' },
            { code: '22', name: 'ISLANDIA' },
            { code: '23', name: 'ISLAS CAIMANES' },
            { code: '24', name: 'ISLAS COCOS (KEELING)' },
            { code: '25', name: 'ISLAS COOK' },
            { code: '26', name: 'ISLAS FEROE' },
            { code: '27', name: 'ISLAS HEARD Y MCDONALD' },
            { code: '28', name: 'ISLAS MALVINAS (FALKLAND)' },
            { code: '29', name: 'ISLAS MARIANAS SEPTENTRIONALES' },
            { code: '30', name: 'ISLAS MARSHALL' },
            { code: '31', name: 'ISLAS REMOTAS MENORES DE LOS ESTADOS UNIDOS' },
            { code: '32', name: 'ISLAS SALOMON' },
            { code: '33', name: 'ISLAS SVALBARD Y JAN MAYEN' },
            { code: '34', name: 'ISLAS TURCAS Y CAICOS' },
            { code: '35', name: 'ISLAS VIRGENES (ESTADOS UNIDOS)' },
            { code: '36', name: 'ISLAS VIRGENES (BRITANICAS)' },
            { code: '37', name: 'ISLAS WALLIS Y FUTUNA' },
            { code: '38', name: 'ISRAEL' },
            { code: '39', name: 'ITALIA' },
            { code: '40', name: 'JAMAHIRIYA ARABE LIBIA' },
            { code: '41', name: 'JAMAICA' },
            { code: '42', name: 'JAPON' },
            { code: '43', name: 'JORDANIA' },
            { code: '44', name: 'KAZAJSTAN' },
            { code: '45', name: 'KENYA' },
            { code: '46', name: 'KIRGUISTAN' },
            { code: '47', name: 'KIRIBATI' },
            { code: '48', name: 'KUWAIT' },
            { code: '49', name: 'LA EX REPUBLICA YUGOSLAVA DE MACEDONIA' },
            { code: '50', name: 'LESOTHO' },
            { code: '51', name: 'LETONIA' },
            { code: '52', name: 'LIBANO' },
            { code: '53', name: 'LIBERIA' },
            { code: '54', name: 'LIECHTENSTEIN' },
            { code: '55', name: 'LITUANIA' },
            { code: '56', name: 'LUXEMBURGO' },
            { code: '57', name: 'MACAO, REGION ADMINISTRATIVA ESPECIAL DE CHINA' },
            { code: '58', name: 'MADAGASCAR' },
            { code: '59', name: 'MALASIA' },
            { code: '60', name: 'MALAWI' },
            { code: '61', name: 'MALDIVAS' },
            { code: '62', name: 'MALI' },
            { code: '63', name: 'MALTA' },
            { code: '64', name: 'MARRUECOS' },
            { code: '65', name: 'MARTINICA' },
            { code: '66', name: 'MAURICIO' },
            { code: '67', name: 'MAURITANIA' },
            { code: '68', name: 'MAYOTTE' },
            { code: '69', name: 'MEXICO' },
            { code: '70', name: 'MICRONESIA (ESTADOS FEDERADOS DE)' },
            { code: '71', name: 'MONACO' },
            { code: '72', name: 'MONGOLIA' },
            { code: '73', name: 'MONTSERRAT' },
            { code: '74', name: 'MOZAMBIQUE' },
            { code: '75', name: 'MYANMAR' },
            { code: '76', name: 'NAMIBIA' },
            { code: '77', name: 'NAURU' },
            { code: '78', name: 'NEPAL' },
            { code: '79', name: 'NICARAGUA' },
            { code: '80', name: 'NIGER' },
            { code: '81', name: 'NIGERIA' },
            { code: '82', name: 'NIUE' },
            { code: '83', name: 'NORUEGA' },
            { code: '84', name: 'NUEVA CALEDONIA' },
            { code: '85', name: 'NUEVA ZELANDIA' },
            { code: '86', name: 'OMAN' },
            { code: '87', name: 'AFGANISTAN' },
            { code: '88', name: 'ALBANIA' },
            { code: '89', name: 'ALEMANIA' },
            { code: '90', name: 'ANDORRA' },
            { code: '91', name: 'ANGOLA' },
            { code: '92', name: 'ANGUILA' },
            { code: '93', name: 'ANTARTIDA' },
            { code: '94', name: 'ANTIGUA Y BARBUDA' },
            { code: '95', name: 'ANTILLAS NEERLANDESAS' },
            { code: '96', name: 'ARABIA SAUDITA' },
            { code: '97', name: 'ARGELIA' },
            { code: '98', name: 'ARGENTINA' },
            { code: '99', name: 'ARMENIA' },
            { code: '100', name: 'ARUBA' },
            { code: '101', name: 'AUSTRALIA' },
            { code: '102', name: 'AUSTRIA' },
            { code: '103', name: 'AZERBAIYAN' },
            { code: '104', name: 'BAHAMAS' },
            { code: '105', name: 'BAHREIN' },
            { code: '106', name: 'BANGLADESH' },
            { code: '107', name: 'BARBADOS' },
            { code: '108', name: 'BELARUS' },
            { code: '109', name: 'BELGICA' },
            { code: '110', name: 'BELICE' },
            { code: '111', name: 'BENIN' },
            { code: '112', name: 'BERMUDAS' },
            { code: '113', name: 'BHUTAN' },
            { code: '114', name: 'BOLIVIA' },
            { code: '115', name: 'BOSNIA Y HERZEGOVINA' },
            { code: '116', name: 'BOTSWANA' },
            { code: '117', name: 'BRASIL' },
            { code: '118', name: 'BRUNEI DARUSSALAM' },
            { code: '119', name: 'BULGARIA' },
            { code: '120', name: 'BURKINA FASO' },
            { code: '121', name: 'BURUNDI' },
            { code: '122', name: 'CABO VERDE' },
            { code: '123', name: 'CAMBOYA' },
            { code: '124', name: 'CAMERUN' },
            { code: '125', name: 'CANADA' },
            { code: '126', name: 'CHAD' },
            { code: '127', name: 'CHILE' },
            { code: '128', name: 'CHINA' },
            { code: '129', name: 'CHIPRE' },
            { code: '130', name: 'COLOMBIA' },
            { code: '131', name: 'COMORAS' },
            { code: '132', name: 'CONGO' },
            { code: '133', name: 'COSTA RICA' },
            { code: '134', name: 'COTE D\'IVOIRE' },
            { code: '135', name: 'CROACIA' },
            { code: '136', name: 'GUATEMALA' },
            { code: '137', name: 'DINAMARCA' },
            { code: '138', name: 'DJIBOUTI' },
            { code: '139', name: 'DOMINICA' },
            { code: '140', name: 'ECUADOR' },
            { code: '141', name: 'EGIPTO' },
            { code: '142', name: 'EL SALVADOR' },
            { code: '143', name: 'EMIRATOS ARABES UNIDOS' },
            { code: '144', name: 'ESLOVAQUIA' },
            { code: '145', name: 'ERITREA' },
            { code: '146', name: 'ESLOVENIA' },
            { code: '147', name: 'ESPAÑA' },
            { code: '148', name: 'ESTADO DE LA CIUDAD DEL VATICANO (SANTA SEDE)' },
            { code: '149', name: 'ESTADOS UNIDOS' },
            { code: '150', name: 'ESTONIA' },
            { code: '151', name: 'ETIOPIA' },
            { code: '152', name: 'FEDERACION DE RUSIA' },
            { code: '153', name: 'FIJI' },
            { code: '154', name: 'FILIPINAS' },
            { code: '155', name: 'FINLANDIA' },
            { code: '156', name: 'FRANCIA' },
            { code: '157', name: 'FRANCIA METROPOLITANA' },
            { code: '158', name: 'GABON' },
            { code: '159', name: 'GAMBIA' },
            { code: '160', name: 'GEORGIA' },
            { code: '161', name: 'GHANA' },
            { code: '162', name: 'GIBRALTAR' },
            { code: '163', name: 'GRANADA' },
            { code: '164', name: 'GRECIA' },
            { code: '165', name: 'GROENLANDIA' },
            { code: '166', name: 'GUADALUPE' },
            { code: '167', name: 'GUINEA CONAKRY' },
            { code: '168', name: 'PAISES BAJOS' },
            { code: '169', name: 'PAKISTAN' },
            { code: '170', name: 'PALAU' },
            { code: '171', name: 'PANAMÁ' },
            { code: '172', name: 'PAPUA NUEVA GUINEA' },
            { code: '173', name: 'PARAGUAY' },
            { code: '174', name: 'PERU' },
            { code: '175', name: 'PITCAIRN' },
            { code: '176', name: 'POLINESIA FRANCESA' },
            { code: '177', name: 'POLONIA' },
            { code: '178', name: 'PORTUGAL' },
            { code: '179', name: 'PUERTO RICO' },
            { code: '180', name: 'QATAR' },
            { code: '181', name: 'REINO UNIDO' },
            { code: '187', name: 'SIRIA' },
            { code: '189', name: 'REPUBLICA CHECA' },
            { code: '191', name: 'REPUBLICA DEMOCRATICA DEL CONGO' },
            { code: '192', name: 'LAOS' },
            { code: '194', name: 'DOMINICANA' },
            { code: '195', name: 'REPUBLICA POPULAR DEMOCRATICA DE COREA' },
            { code: '196', name: 'TANZANIA' },
            { code: '197', name: 'REUNION' },
            { code: '198', name: 'RUMANIA' },
            { code: '199', name: 'RWANDA' },
            { code: '200', name: 'SAHARA OCCIDENTAL' },
            { code: '201', name: 'SAINT KITTS Y NEVIS' },
            { code: '202', name: 'SAMOA' },
            { code: '203', name: 'SAMOA ESTADOUNIDENSE' },
            { code: '204', name: 'SAN MARINO' },
            { code: '205', name: 'SAN VICENTE Y LAS GRANADINAS' },
            { code: '206', name: 'SANTA HELENA' },
            { code: '207', name: 'SANTA LUCIA' },
            { code: '208', name: 'SANTO TOME Y PRINCIPE' },
            { code: '209', name: 'SENEGAL' },
            { code: '210', name: 'SEYCHELLES' },
            { code: '211', name: 'SIERRA LEONA' },
            { code: '212', name: 'SINGAPUR' },
            { code: '213', name: 'SOMALIA' },
            { code: '214', name: 'SRI LANKA' },
            { code: '215', name: 'ST. PIERRE Y MIQUELON' },
            { code: '216', name: 'SUDAFRICA' },
            { code: '217', name: 'SUDAN' },
            { code: '218', name: 'SUECIA' },
            { code: '219', name: 'SUIZA' },
            { code: '220', name: 'SURINAME' },
            { code: '221', name: 'SWAZILANDIA' },
            { code: '222', name: 'TAILANDIA' },
            { code: '223', name: 'TAIWAN, PROVINCIA DE CHINA' },
            { code: '224', name: 'TAYIKISTAN' },
            { code: '228', name: 'TIMOR ORIENTAL' },
            { code: '229', name: 'TOGO' },
            { code: '230', name: 'TOKELAU' },
            { code: '231', name: 'TONGA' },
            { code: '232', name: 'TRINIDAD Y TOBAGO' },
            { code: '233', name: 'TUNEZ' },
            { code: '234', name: 'TURKMENISTAN' },
            { code: '235', name: 'TURQUIA' },
            { code: '236', name: 'TUVALU' },
            { code: '237', name: 'UCRANIA' },
            { code: '238', name: 'UGANDA' },
            { code: '239', name: 'URUGUAY' },
            { code: '240', name: 'UZBEKISTAN' },
            { code: '241', name: 'VANUATU' },
            { code: '242', name: 'VENEZUELA' },
            { code: '243', name: 'VIET NAM' },
            { code: '244', name: 'YEMEN' },
            { code: '245', name: 'SERBIA' },
            { code: '246', name: 'ZAMBIA' },
            { code: '247', name: 'ZIMBABWE' },
            { code: '248', name: 'TERRITORIO BRITANICO INDICO' },
            { code: '249', name: 'REPUBLICA CENTROAFRICANA' },
            { code: '250', name: 'GUAM' },
            { code: '251', name: 'MOLDAVIA' },
            { code: '252', name: 'GEORGIA/ SANDWICH DEL SUR' },
            { code: '253', name: 'COREA SUR' },
            { code: '254', name: 'PALESTINA' },
            { code: '255', name: 'LIBIA' },
            { code: '256', name: 'SUDAN DEL SUR' }
        ];

        // Crear un mapa de códigos ISO a códigos numéricos
        const isoToNumericCode = {
            'CU': '1', 'GF': '5', 'GN': '6', 'GW': '7', 'GQ': '8', 'GY': '9',
            'HT': '10', 'HN': '11', 'HK': '12', 'HU': '13', 'IN': '14', 'ID': '15',
            'IR': '16', 'IQ': '17', 'IE': '18', 'BV': '19', 'CX': '20', 'NF': '21',
            'IS': '22', 'KY': '23', 'CC': '24', 'CK': '25', 'FO': '26', 'HM': '27',
            'FK': '28', 'MP': '29', 'MH': '30', 'UM': '31', 'SB': '32', 'SJ': '33',
            'TC': '34', 'VI': '35', 'VG': '36', 'WF': '37', 'IL': '38', 'IT': '39',
            'LY': '40', 'JM': '41', 'JP': '42', 'JO': '43', 'KZ': '44', 'KE': '45',
            'KG': '46', 'KI': '47', 'KW': '48', 'MK': '49', 'LS': '50', 'LV': '51',
            'LB': '52', 'LR': '53', 'LI': '54', 'LT': '55', 'LU': '56', 'MO': '57',
            'MG': '58', 'MY': '59', 'MW': '60', 'MV': '61', 'ML': '62', 'MT': '63',
            'MA': '64', 'MQ': '65', 'MU': '66', 'MR': '67', 'YT': '68', 'MX': '69',
            'FM': '70', 'MC': '71', 'MN': '72', 'MS': '73', 'MZ': '74', 'MM': '75',
            'NA': '76', 'NR': '77', 'NP': '78', 'NI': '79', 'NE': '80', 'NG': '81',
            'NU': '82', 'NO': '83', 'NC': '84', 'NZ': '85', 'OM': '86', 'AF': '87',
            'AL': '88', 'DE': '89', 'AD': '90', 'AO': '91', 'AI': '92', 'AQ': '93',
            'AG': '94', 'AN': '95', 'SA': '96', 'DZ': '97', 'AR': '98', 'AM': '99',
            'AW': '100', 'AU': '101', 'AT': '102', 'AZ': '103', 'BS': '104', 'BH': '105',
            'BD': '106', 'BB': '107', 'BY': '108', 'BE': '109', 'BZ': '110', 'BJ': '111',
            'BM': '112', 'BT': '113', 'BO': '114', 'BA': '115', 'BW': '116', 'BR': '117',
            'BN': '118', 'BG': '119', 'BF': '120', 'BI': '121', 'CV': '122', 'KH': '123',
            'CM': '124', 'CA': '125', 'TD': '126', 'CL': '127', 'CN': '128', 'CY': '129',
            'CO': '130', 'KM': '131', 'CG': '132', 'CR': '133', 'CI': '134', 'HR': '135',
            'GT': '136', 'DK': '137', 'DJ': '138', 'DM': '139', 'EC': '140', 'EG': '141',
            'SV': '142', 'AE': '143', 'SK': '144', 'ER': '145', 'SI': '146', 'ES': '147',
            'VA': '148', 'US': '149', 'EE': '150', 'ET': '151', 'RU': '152', 'FJ': '153',
            'PH': '154', 'FI': '155', 'FR': '156', 'FX': '157', 'GA': '158', 'GM': '159',
            'GE': '160', 'GH': '161', 'GI': '162', 'GD': '163', 'GR': '164', 'GL': '165',
            'GP': '166', 'GC': '167', 'NL': '168', 'PK': '169', 'PW': '170', 'PA': '171',
            'PG': '172', 'PY': '173', 'PE': '174', 'PN': '175', 'PF': '176', 'PL': '177',
            'PT': '178', 'PR': '179', 'QA': '180', 'GB': '181', 'SY': '187', 'CZ': '189',
            'CD': '191', 'LA': '192', 'DO': '194', 'KP': '195', 'TZ': '196', 'RE': '197',
            'RO': '198', 'RW': '199', 'EH': '200', 'KN': '201', 'WS': '202', 'AS': '203',
            'SM': '204', 'VC': '205', 'SH': '206', 'LC': '207', 'ST': '208', 'SN': '209',
            'SC': '210', 'SL': '211', 'SG': '212', 'SO': '213', 'LK': '214', 'PM': '215',
            'ZA': '216', 'SD': '217', 'SE': '218', 'CH': '219', 'SR': '220', 'SZ': '221',
            'TH': '222', 'TW': '223', 'TJ': '224', 'TL': '228', 'TG': '229', 'TK': '230',
            'TO': '231', 'TT': '232', 'TN': '233', 'TM': '234', 'TR': '235', 'TV': '236',
            'UA': '237', 'UG': '238', 'UY': '239', 'UZ': '240', 'VU': '241', 'VE': '242',
            'VN': '243', 'YE': '244', 'RS': '245', 'ZM': '246', 'ZW': '247', 'IO': '248',
            'CF': '249', 'GU': '250', 'MD': '251', 'GS': '252', 'KR': '253', 'PS': '254',
            'SS': '256'
        };

        // Crear el mapa inverso (de numérico a ISO)
        const numericToIsoCode = {};
        Object.entries(isoToNumericCode).forEach(([isoCode, numericCode]) => {
            numericToIsoCode[numericCode] = isoCode;
        });

        const provinciasHistoricas = { /* Full list omitted for brevity - assumed present */
            before1976: [{
                code: '1001', name: 'Pinar del Río', municipios: [
                    { code: '694', name: 'Pinar del Río' },
                    { code: '697', name: 'San Juan y Martínez' },
                    { code: '698', name: 'San Luis' },
                    { code: '688', name: 'Consolación del Sur' },
                    { code: '691', name: 'Los Palacios' },
                    { code: '689', name: 'Viñales' }
                ]
            },
            {
                code: '1002', name: 'La Habana', municipios: [
                    { code: '721', name: 'La Habana' },
                    { code: '728', name: 'Marianao' },
                    { code: '730', name: 'Regla' },
                    { code: '725', name: 'Guanabacoa' },
                    { code: '0', name: 'Santiago de las Vegas' },
                    { code: '703', name: 'Bauta' },
                    { code: '715', name: 'San Antonio de los Baños' }
                ]
            },
            {
                code: '674', name: 'Matanzas', municipios: [
                    { code: '740', name: 'Matanzas' },
                    { code: '735', name: 'Cárdenas' },
                    { code: '737', name: 'Colón' },
                    { code: '850', name: 'Jagüey Grande' },
                    { code: '851', name: 'Jovellanos' },
                    { code: '743', name: 'Unión de Reyes' }
                ]
            },
            {
                code: '1004', name: 'Las Villas', municipios: [
                    { code: '756', name: 'Santa Clara' },
                    { code: '760', name: 'Cienfuegos' },
                    { code: '770', name: 'Sancti Spíritus' },
                    { code: '772', name: 'Trinidad' },
                    { code: '755', name: 'Sagua la Grande' },
                    { code: '754', name: 'Remedios' }
                ]
            },
            {
                code: '679', name: 'Camagüey', municipios: [
                    { code: '847', name: 'Camagüey' },
                    { code: '792', name: 'Nuevitas' },
                    { code: '787', name: 'Florida' },
                    { code: '781', name: 'Morón' },
                    { code: '776', name: 'Ciego de Ávila' }
                ]
            },
            {
                code: '1006', name: 'Oriente', municipios: [
                    { code: '835', name: 'Santiago de Cuba' },
                    { code: '849', name: 'Guantánamo' },
                    { code: '817', name: 'Bayamo' },
                    { code: '848', name: 'Holguín' },
                    { code: '823', name: 'Manzanillo' },
                    { code: '853', name: 'Las Tunas' }
                ]
            }],
            after1976: [{
                code: '910', name: 'Pinar del Río', municipios: [
                    { code: '696', name: 'Sandino' },
                    { code: '692', name: 'Mantua' },
                    { code: '693', name: 'Minas de Matahambre' },
                    { code: '699', name: 'Viñales' },
                    { code: '690', name: 'La Palma' },
                    { code: '691', name: 'Los Palacios' },
                    { code: '688', name: 'Consolación del Sur' },
                    { code: '694', name: 'Pinar del Río' },
                    { code: '698', name: 'San Luis' },
                    { code: '697', name: 'San Juan y Martínez' },
                    { code: '689', name: 'Guane' }
                ]
            },
            {
                code: '673', name: 'La Habana', municipios: [
                    { code: '729', name: 'Playa' },
                    { code: '733', name: 'Plaza de la Revolución' },
                    { code: '720', name: 'Centro Habana' },
                    { code: '721', name: 'La Habana Vieja' },
                    { code: '730', name: 'Regla' },
                    { code: '726', name: 'La Habana del Este' },
                    { code: '725', name: 'Guanabacoa' },
                    { code: '731', name: 'San Miguel del Padrón' },
                    { code: '724', name: 'Diez de Octubre' },
                    { code: '722', name: 'Cerro' },
                    { code: '728', name: 'Marianao' },
                    { code: '727', name: 'La Lisa' },
                    { code: '732', name: 'Boyeros' },
                    { code: '719', name: 'Arroyo Naranjo' },
                    { code: '723', name: 'Cotorro' }
                ]
            },
            {
                code: '674', name: 'Matanzas', municipios: [
                    { code: '740', name: 'Matanzas' },
                    { code: '735', name: 'Cárdenas' },
                    { code: '744', name: 'Varadero' },
                    { code: '851', name: 'Jovellanos' },
                    { code: '741', name: 'Pedro Betancourt' },
                    { code: '737', name: 'Colón' },
                    { code: '742', name: 'Perico' },
                    { code: '738', name: 'Los Arabos' },
                    { code: '734', name: 'Calimete' },
                    { code: '850', name: 'Jagüey Grande' },
                    { code: '852', name: 'Limonar' },
                    { code: '743', name: 'Unión de Reyes' },
                    { code: '736', name: 'Ciénaga de Zapata' }
                ]
            },
            {
                code: '675', name: 'Villa Clara', municipios: [
                    { code: '756', name: 'Santa Clara' },
                    { code: '754', name: 'Remedios' },
                    { code: '755', name: 'Sagua la Grande' },
                    { code: '751', name: 'Placetas' },
                    { code: '746', name: 'Camajuaní' },
                    { code: '745', name: 'Caibarién' },
                    { code: '747', name: 'Cifuentes' },
                    { code: '757', name: 'Santo Domingo' },
                    { code: '753', name: 'Ranchuelo' },
                    { code: '750', name: 'Manicaragua' },
                    { code: '752', name: 'Quemado de Güines' },
                    { code: '749', name: 'Encrucijada' },
                    { code: '748', name: 'Corralillo' }
                ]
            },
            {
                code: '676', name: 'Cienfuegos', municipios: [
                    { code: '760', name: 'Cienfuegos' },
                    { code: '759', name: 'Aguada de Pasajeros' },
                    { code: '765', name: 'Rodas' },
                    { code: '764', name: 'Palmira' },
                    { code: '763', name: 'Lajas' },
                    { code: '762', name: 'Cruces' },
                    { code: '761', name: 'Cumanayagua' },
                    { code: '758', name: 'Abreus' }
                ]
            },
            {
                code: '677', name: 'Sancti Spíritus', municipios: [
                    { code: '770', name: 'Sancti Spíritus' },
                    { code: '772', name: 'Trinidad' },
                    { code: '766', name: 'Cabaiguán' },
                    { code: '773', name: 'Yaguajay' },
                    { code: '768', name: 'Jatibonico' },
                    { code: '767', name: 'Fomento' },
                    { code: '769', name: 'La Sierpe' },
                    { code: '771', name: 'Taguasco' }
                ]
            },
            {
                code: '678', name: 'Ciego de Ávila', municipios: [
                    { code: '776', name: 'Ciego de Ávila' },
                    { code: '781', name: 'Morón' },
                    { code: '778', name: 'Chambas' },
                    { code: '782', name: 'Venezuela' },
                    { code: '774', name: 'Baraguá' },
                    { code: '775', name: 'Bolivia' },
                    { code: '783', name: 'Primero de Enero' },
                    { code: '779', name: 'Florencia' },
                    { code: '780', name: 'Majagua' },
                    { code: '777', name: 'Ciro Redondo' }
                ]
            },
            {
                code: '679', name: 'Camagüey', municipios: [
                    { code: '847', name: 'Camagüey' },
                    { code: '792', name: 'Nuevitas' },
                    { code: '787', name: 'Florida' },
                    { code: '786', name: 'Esmeralda' },
                    { code: '795', name: 'Vertientes' },
                    { code: '793', name: 'Santa Cruz del Sur' },
                    { code: '788', name: 'Guáimaro' },
                    { code: '794', name: 'Sibanicú' },
                    { code: '790', name: 'Minas' },
                    { code: '785', name: 'Sierra de Cubitas' },
                    { code: '791', name: 'Najasa' },
                    { code: '789', name: 'Jimaguayú' },
                    { code: '784', name: 'Carlos Manuel de Céspedes' }
                ]
            },
            {
                code: '680', name: 'Las Tunas', municipios: [
                    { code: '853', name: 'Las Tunas' },
                    { code: '802', name: 'Puerto Padre' },
                    { code: '798', name: 'Jobabo' },
                    { code: '797', name: 'Colombia' },
                    { code: '800', name: 'Manatí' },
                    { code: '799', name: 'Majibacoa' },
                    { code: '796', name: 'Amancio' },
                    { code: '801', name: 'Jesús Menéndez' }
                ]
            },
            {
                code: '681', name: 'Holguín', municipios: [
                    { code: '848', name: 'Holguín' },
                    { code: '810', name: 'Gibara' },
                    { code: '813', name: 'Rafael Freyre' },
                    { code: '804', name: 'Banes' },
                    { code: '803', name: 'Antilla' },
                    { code: '805', name: 'Báguanos' },
                    { code: '811', name: 'Mayarí' },
                    { code: '809', name: 'Frank País' },
                    { code: '814', name: 'Sagua de Tánamo' },
                    { code: '812', name: 'Moa' },
                    { code: '807', name: 'Calixto García' },
                    { code: '815', name: 'Urbano Noris' },
                    { code: '808', name: 'Cueto' },
                    { code: '806', name: 'Cacocum' }
                ]
            },
            {
                code: '682', name: 'Granma', municipios: [
                    { code: '817', name: 'Bayamo' },
                    { code: '823', name: 'Manzanillo' },
                    { code: '828', name: 'Yara' },
                    { code: '819', name: 'Campechuela' },
                    { code: '824', name: 'Media Luna' },
                    { code: '825', name: 'Niquero' },
                    { code: '826', name: 'Pilón' },
                    { code: '816', name: 'Bartolomé Masó' },
                    { code: '822', name: 'Jiguaní' },
                    { code: '818', name: 'Buey Arriba' },
                    { code: '821', name: 'Guisa' },
                    { code: '820', name: 'Cauto Cristo' },
                    { code: '827', name: 'Río Cauto' }
                ]
            },
            {
                code: '683', name: 'Santiago de Cuba', municipios: [
                    { code: '835', name: 'Santiago de Cuba' },
                    { code: '833', name: 'Palma Soriano' },
                    { code: '829', name: 'Contramaestre' },
                    { code: '834', name: 'San Luis' },
                    { code: '836', name: 'Segundo Frente' },
                    { code: '831', name: 'Songo-La Maya' },
                    { code: '832', name: 'Mella' },
                    { code: '837', name: 'Tercer Frente' },
                    { code: '830', name: 'Guamá' }
                ]
            },
            {
                code: '684', name: 'Guantánamo', municipios: [
                    { code: '849', name: 'Guantánamo' },
                    { code: '838', name: 'Baracoa' },
                    { code: '842', name: 'Maisí' },
                    { code: '845', name: 'San Antonio del Sur' },
                    { code: '846', name: 'Yateras' },
                    { code: '840', name: 'El Salvador' },
                    { code: '843', name: 'Manuel Tames' },
                    { code: '841', name: 'Imías' },
                    { code: '844', name: 'Niceto Pérez' },
                    { code: '839', name: 'Caimanera' }
                ]
            },
            {
                code: '685', name: 'Isla de la Juventud', municipios: [
                    { code: '518', name: 'Nueva Gerona' }
                ]
            }],
            after2011: [{
                code: '910', name: 'Pinar del Río', municipios: [
                    { code: '913', name: 'Sandino' },
                    { code: '914', name: 'Mantua' },
                    { code: '915', name: 'Minas de Matahambre' },
                    { code: '916', name: 'Viñales' },
                    { code: '917', name: 'La Palma' },
                    { code: '918', name: 'Los Palacios' },
                    { code: '919', name: 'Consolación del Sur' },
                    { code: '920', name: 'Pinar del Río' },
                    { code: '921', name: 'San Luis' },
                    { code: '922', name: 'San Juan y Martínez' },
                    { code: '923', name: 'Guane' }
                ]
            },
            {
                code: '911', name: 'Artemisa', municipios: [
                    { code: '931', name: 'Alquízar' },
                    { code: '932', name: 'Artemisa' },
                    { code: '928', name: 'Bauta' },
                    { code: '927', name: 'Caimito' },
                    { code: '926', name: 'Guanajay' },
                    { code: '930', name: 'Güira de Melena' },
                    { code: '925', name: 'Mariel' },
                    { code: '929', name: 'San Antonio de los Baños' },
                    { code: '924', name: 'Bahía Honda' },
                    { code: '934', name: 'San Cristóbal' },
                    { code: '933', name: 'Candelaria' }
                ]
            },
            {
                code: '673', name: 'La Habana', municipios: [
                    { code: '729', name: 'Playa' },
                    { code: '733', name: 'Plaza de la Revolución' },
                    { code: '720', name: 'Centro Habana' },
                    { code: '721', name: 'La Habana Vieja' },
                    { code: '730', name: 'Regla' },
                    { code: '726', name: 'Habana del Este' },
                    { code: '725', name: 'Guanabacoa' },
                    { code: '731', name: 'San Miguel del Padrón' },
                    { code: '724', name: 'Diez de Octubre' },
                    { code: '722', name: 'Cerro' },
                    { code: '728', name: 'Marianao' },
                    { code: '727', name: 'La Lisa' },
                    { code: '732', name: 'Boyeros' },
                    { code: '719', name: 'Arroyo Naranjo' },
                    { code: '723', name: 'Cotorro' }
                ]
            },
            {
                code: '912', name: 'Mayabeque', municipios: [
                    { code: '935', name: 'Bejucal' },
                    { code: '936', name: 'San José de las Lajas' },
                    { code: '937', name: 'Jaruco' },
                    { code: '938', name: 'Santa Cruz del Norte' },
                    { code: '939', name: 'Madruga' },
                    { code: '940', name: 'Nueva Paz' },
                    { code: '941', name: 'San Nicolás' },
                    { code: '942', name: 'Güines' },
                    { code: '943', name: 'Melena del Sur' },
                    { code: '944', name: 'Batabanó' },
                    { code: '945', name: 'Quivicán' }
                ]
            },
            {
                code: '674', name: 'Matanzas', municipios: [
                    { code: '740', name: 'Matanzas' },
                    { code: '735', name: 'Cárdenas' },
                    { code: '744', name: 'Varadero' },
                    { code: '851', name: 'Jovellanos' },
                    { code: '741', name: 'Pedro Betancourt' },
                    { code: '737', name: 'Colón' },
                    { code: '742', name: 'Perico' },
                    { code: '738', name: 'Los Arabos' },
                    { code: '734', name: 'Calimete' },
                    { code: '850', name: 'Jagüey Grande' },
                    { code: '852', name: 'Limonar' },
                    { code: '743', name: 'Unión de Reyes' },
                    { code: '736', name: 'Ciénaga de Zapata' }
                ]
            },
            {
                code: '675', name: 'Villa Clara', municipios: [
                    { code: '756', name: 'Santa Clara' },
                    { code: '754', name: 'Remedios' },
                    { code: '755', name: 'Sagua la Grande' },
                    { code: '751', name: 'Placetas' },
                    { code: '746', name: 'Camajuaní' },
                    { code: '745', name: 'Caibarién' },
                    { code: '747', name: 'Cifuentes' },
                    { code: '757', name: 'Santo Domingo' },
                    { code: '753', name: 'Ranchuelo' },
                    { code: '750', name: 'Manicaragua' },
                    { code: '752', name: 'Quemado de Güines' },
                    { code: '749', name: 'Encrucijada' },
                    { code: '748', name: 'Corralillo' }
                ]
            },
            {
                code: '676', name: 'Cienfuegos', municipios: [
                    { code: '760', name: 'Cienfuegos' },
                    { code: '759', name: 'Aguada de Pasajeros' },
                    { code: '765', name: 'Rodas' },
                    { code: '764', name: 'Palmira' },
                    { code: '763', name: 'Lajas' },
                    { code: '762', name: 'Cruces' },
                    { code: '761', name: 'Cumanayagua' },
                    { code: '758', name: 'Abreus' }
                ]
            },
            {
                code: '677', name: 'Sancti Spíritus', municipios: [
                    { code: '770', name: 'Sancti Spíritus' },
                    { code: '772', name: 'Trinidad' },
                    { code: '766', name: 'Cabaiguán' },
                    { code: '773', name: 'Yaguajay' },
                    { code: '768', name: 'Jatibonico' },
                    { code: '767', name: 'Fomento' },
                    { code: '769', name: 'La Sierpe' },
                    { code: '771', name: 'Taguasco' }
                ]
            },
            {
                code: '678', name: 'Ciego de Ávila', municipios: [
                    { code: '776', name: 'Ciego de Ávila' },
                    { code: '781', name: 'Morón' },
                    { code: '778', name: 'Chambas' },
                    { code: '782', name: 'Venezuela' },
                    { code: '774', name: 'Baraguá' },
                    { code: '775', name: 'Bolivia' },
                    { code: '783', name: 'Primero de Enero' },
                    { code: '779', name: 'Florencia' },
                    { code: '780', name: 'Majagua' },
                    { code: '777', name: 'Ciro Redondo' }
                ]
            },
            {
                code: '679', name: 'Camagüey', municipios: [
                    { code: '847', name: 'Camagüey' },
                    { code: '792', name: 'Nuevitas' },
                    { code: '787', name: 'Florida' },
                    { code: '786', name: 'Esmeralda' },
                    { code: '795', name: 'Vertientes' },
                    { code: '793', name: 'Santa Cruz del Sur' },
                    { code: '788', name: 'Guáimaro' },
                    { code: '794', name: 'Sibanicú' },
                    { code: '790', name: 'Minas' },
                    { code: '785', name: 'Sierra de Cubitas' },
                    { code: '791', name: 'Najasa' },
                    { code: '789', name: 'Jimaguayú' },
                    { code: '784', name: 'Carlos Manuel de Céspedes' }
                ]
            },
            {
                code: '680', name: 'Las Tunas', municipios: [
                    { code: '853', name: 'Las Tunas' },
                    { code: '802', name: 'Puerto Padre' },
                    { code: '798', name: 'Jobabo' },
                    { code: '797', name: 'Colombia' },
                    { code: '800', name: 'Manatí' },
                    { code: '799', name: 'Majibacoa' },
                    { code: '796', name: 'Amancio' },
                    { code: '801', name: 'Jesús Menéndez' }
                ]
            },
            {
                code: '681', name: 'Holguín', municipios: [
                    { code: '848', name: 'Holguín' },
                    { code: '810', name: 'Gibara' },
                    { code: '813', name: 'Rafael Freyre' },
                    { code: '804', name: 'Banes' },
                    { code: '803', name: 'Antilla' },
                    { code: '805', name: 'Báguanos' },
                    { code: '811', name: 'Mayarí' },
                    { code: '809', name: 'Frank País' },
                    { code: '814', name: 'Sagua de Tánamo' },
                    { code: '812', name: 'Moa' },
                    { code: '807', name: 'Calixto García' },
                    { code: '815', name: 'Urbano Noris' },
                    { code: '808', name: 'Cueto' },
                    { code: '806', name: 'Cacocum' }
                ]
            },
            {
                code: '682', name: 'Granma', municipios: [
                    { code: '817', name: 'Bayamo' },
                    { code: '823', name: 'Manzanillo' },
                    { code: '828', name: 'Yara' },
                    { code: '819', name: 'Campechuela' },
                    { code: '824', name: 'Media Luna' },
                    { code: '825', name: 'Niquero' },
                    { code: '826', name: 'Pilón' },
                    { code: '816', name: 'Bartolomé Masó' },
                    { code: '822', name: 'Jiguaní' },
                    { code: '818', name: 'Buey Arriba' },
                    { code: '821', name: 'Guisa' },
                    { code: '820', name: 'Cauto Cristo' },
                    { code: '827', name: 'Río Cauto' }
                ]
            },
            {
                code: '683', name: 'Santiago de Cuba', municipios: [
                    { code: '835', name: 'Santiago de Cuba' },
                    { code: '833', name: 'Palma Soriano' },
                    { code: '829', name: 'Contramaestre' },
                    { code: '834', name: 'San Luis' },
                    { code: '836', name: 'Segundo Frente' },
                    { code: '831', name: 'Songo-La Maya' },
                    { code: '832', name: 'Mella' },
                    { code: '837', name: 'Tercer Frente' },
                    { code: '830', name: 'Guamá' }
                ]
            },
            {
                code: '684', name: 'Guantánamo', municipios: [
                    { code: '849', name: 'Guantánamo' },
                    { code: '838', name: 'Baracoa' },
                    { code: '842', name: 'Maisí' },
                    { code: '845', name: 'San Antonio del Sur' },
                    { code: '846', name: 'Yateras' },
                    { code: '840', name: 'El Salvador' },
                    { code: '843', name: 'Manuel Tames' },
                    { code: '841', name: 'Imías' },
                    { code: '844', name: 'Niceto Pérez' },
                    { code: '839', name: 'Caimanera' }
                ]
            },
            {
                code: '685', name: 'Isla de la Juventud', municipios: [
                    { code: '518', name: 'Nueva Gerona' }
                ]
            }]
        };
        const consulados = [
            { code: '10', name: 'BELICE' },
            { code: '11', name: 'BELGICA' },
            { code: '12', name: 'BENIN' },
            { code: '13', name: 'BERLIN' },
            { code: '14', name: 'BURKINA FASO(ALTO V)' },
            { code: '15', name: 'BIELORRUSIA' },
            { code: '16', name: 'BOLIVIA' },
            { code: '17', name: 'BONN' },
            { code: '18', name: 'BOSTWANA' },
            { code: '19', name: 'BRASIL' },
            { code: '20', name: 'BARCELONA' },
            { code: '21', name: 'BUDAPEST' },
            { code: '22', name: 'BULGARIA' },
            { code: '23', name: 'CANCUN' },
            { code: '24', name: 'CARACAS' },
            { code: '25', name: 'COREA NORTE (DEMOCRACTICA)' },
            { code: '26', name: 'BRATISLAVA' },
            { code: '27', name: 'CHILE' },
            { code: '28', name: 'CHIPRE' },
            { code: '29', name: 'CANTON, CHINA' },
            { code: '30', name: 'COLOMBIA' },
            { code: '31', name: 'CONGO(BRAZAVILLE)' },
            { code: '32', name: 'COSTA RICA' },
            { code: '33', name: 'CABO VERDE ISLAS,' },
            { code: '34', name: 'DINAMARCA' },
            { code: '35', name: 'DOMINICA' },
            { code: '36', name: 'ECUADOR' },
            { code: '37', name: 'EGIPTO (RAE)' },
            { code: '38', name: 'MADRID' },
            { code: '39', name: 'ETIOPIA' },
            { code: '40', name: 'FILIPINAS' },
            { code: '41', name: 'FINLANDIA' },
            { code: '42', name: 'FRANCIA' },
            { code: '43', name: 'GALICIA' },
            { code: '44', name: 'GAMBIA' },
            { code: '45', name: 'GUINEA BISSAU' },
            { code: '46', name: 'GUINEA ECUATORIAL' },
            { code: '47', name: 'GHANA' },
            { code: '48', name: 'GRANADA ISLA' },
            { code: '49', name: 'GRECIA' },
            { code: '50', name: 'GUATEMALA' },
            { code: '51', name: 'GUINEA CONAKRY' },
            { code: '52', name: 'GUYANA BRITANICA' },
            { code: '53', name: 'HAITI' },
            { code: '54', name: 'HANOI' },
            { code: '55', name: 'WASHINGTON (HAVANATUR)' },
            { code: '56', name: 'HOLANDA' },
            { code: '57', name: 'HONDURAS' },
            { code: '58', name: 'Islas Canarias' },
            { code: '59', name: 'INDONESIA' },
            { code: '60', name: 'INDIA' },
            { code: '61', name: 'GRAN BRETAÑA' },
            { code: '62', name: 'IRLANDA' },
            { code: '63', name: 'IRAN' },
            { code: '64', name: 'JAMAICA' },
            { code: '65', name: 'JAPON' },
            { code: '66', name: 'CAMBODIA' },
            { code: '67', name: 'KAZAJASTAN' },
            { code: '68', name: 'KENYA' },
            { code: '69', name: 'KUWAIT' },
            { code: '70', name: 'LAOS' },
            { code: '71', name: 'LIBIA' },
            { code: '72', name: 'LIBANO' },
            { code: '73', name: 'MALASIA' },
            { code: '74', name: 'MERIDA' },
            { code: '75', name: 'MEXICO' },
            { code: '76', name: 'MILAN(ITALIA)' },
            { code: '77', name: 'HO CHI MIN' },
            { code: '78', name: 'MALI' },
            { code: '79', name: 'MONTREAL' },
            { code: '80', name: 'MONGOLIA' },
            { code: '81', name: 'MOSCU' },
            { code: '82', name: 'MOZAMBIQUE' },
            { code: '83', name: 'NAMIBIA' },
            { code: '84', name: 'NICARAGUA' },
            { code: '85', name: 'NIGERIA' },
            { code: '86', name: 'NIGER' },
            { code: '87', name: 'NORUEGA' },
            { code: '88', name: 'OTTAWA' },
            { code: '89', name: 'PAKISTAN' },
            { code: '90', name: 'PANAMÁ' },
            { code: '91', name: 'PARAGUAY' },
            { code: '92', name: 'PERÚ' },
            { code: '93', name: 'POLONIA' },
            { code: '94', name: 'PORTUGAL' },
            { code: '95', name: 'QATAR' },
            { code: '96', name: 'REPUBL.CHECA' },
            { code: '97', name: 'CHINA' },
            { code: '98', name: 'R.DOMINICANA' },
            { code: '99', name: 'MONTERREY(MEXICO)' },
            { code: '100', name: 'ROMA(ITALIA)' },
            { code: '101', name: 'REP.SUDAFRICA' },
            { code: '102', name: 'RUMANIA' },
            { code: '103', name: 'SAN KITTS Y NEVIS' },
            { code: '104', name: 'SANTA CRUZ, BOLIVIA' },
            { code: '105', name: 'SENEGAL' },
            { code: '106', name: 'SEVILLA' },
            { code: '107', name: 'SEYCHELLES ISLAS' },
            { code: '108', name: 'SHANGAI' },
            { code: '109', name: 'SIRIA' },
            { code: '110', name: 'SANTA LUCIA' },
            { code: '111', name: 'SAO PAULO(BRASIL)' },
            { code: '112', name: 'SRI LANKA' },
            { code: '113', name: 'SUECIA' },
            { code: '114', name: 'SUIZA' },
            { code: '115', name: 'SURINAME' },
            { code: '116', name: 'SAN VICENTE Y GRANADINAS' },
            { code: '117', name: 'TAILANDIA' },
            { code: '118', name: 'TANZANIA' },
            { code: '119', name: 'TIMOR LESTE' },
            { code: '120', name: 'TORONTO' },
            { code: '121', name: 'TRINIDAD-TOBAGO ISLA' },
            { code: '122', name: 'TUNEZ' },
            { code: '123', name: 'TURQUIA' },
            { code: '124', name: 'UGANDA' },
            { code: '125', name: 'UCRANIA' },
            { code: '126', name: 'URUGUAY' },
            { code: '127', name: 'WASHINGTON' },
            { code: '128', name: 'VALENCIA' },
            { code: '129', name: 'VERACRUZ' },
            { code: '130', name: 'YEMEN' },
            { code: '131', name: 'YUGOSLAVIA' },
            { code: '132', name: 'ZAMBIA' },
            { code: '133', name: 'ZIMBABWE' },
            { code: '137', name: 'USACANADA' },
            { code: '138', name: 'USAMEXICO' },
            { code: '139', name: 'ANTIGUA Y BARBUDAS' },
            { code: '140', name: 'ANGOLA' },
            { code: '141', name: 'ARGELIA' },
            { code: '142', name: 'ARGENTINA' },
            { code: '143', name: 'AUSTRALIA' },
            { code: '144', name: 'AUSTRIA' },
            { code: '145', name: 'BAHAMAS ISLAS' },
            { code: '146', name: 'BARINAS' },
            { code: '147', name: 'BARBADOS' },
            { code: '148', name: 'INSTALACION' },
            { code: '149', name: 'AZERBAIYAN' }
        ];

        // Objeto que mapea códigos ISO a consulados disponibles
        const consuladosDataRawISO = `ISO_CODE,PAÍS,CONSULADO\nUS,ESTADOS UNIDOS,WASHINGTON\nAG,ANTIGUA Y BARBUDA,Saint John\nAR,ARGENTINA,Buenos Aires\nBS,BAHAMAS,NasáBriu\nBB,BARBADOS,Bidgetown\nBZ,BELICE,Balmopán\nBO,BOLIVIA,La Paz\nBO,,Santa Cruz\nBR,BRASIL,Brasilia\nBR,,São Paulo\nCL,CHILE,Santiago de Chile\nCO,COLOMBIA,Bogotá\nCR,COSTA RICA,San José\nDM,DOMINICA,Roseau\nEC,ECUADOR,Quito\nSV,EL SALVADOR,San Salvador\nHT,HAITI,Puerto Príncipe\nHN,HONDURAS,Tegucigalpa\nJM,JAMAICA,Kingston\nGD,GRANADA,Saint George\nGT,GUATEMALA,Ciudad de Guatemala\nGY,GUYANA,Georgetown\nMX,MÉXICO,Cancún\nMX,,Ciudad de México\nMX,,Mérida\nMX,,Monterrey\nMX,,Veracruz\nNI,NICARAGUA,Managua\nPA,PANAMÁ,Panamá\nPY,PARAGUAY,Asunción\nPE,PERÚ,Lima\nDO,REPUBLICA DOMINICANA,Santo Domingo\nKN,SAINT KITTS Y NEVIS,Basseterre\nVC,SAN VICENTE Y LAS GRANADINAS,Kingstown\nLC,SANTA LUCIA,Castries\nSR,SURINAM,Paramaribo\nTT,TRINIDAD TOBAGO,Puerto España\nUY,URUGUAY,Montevideo\nVE,VENEZUELA,Caracas\nDE,Alemania,Berlin\nDE,,Bonn\nAT,Austria,Viena\nAZ,Azerbaiyan,Baku\nBY,Belarus,Minsk\nBE,Belgica,Bruselas\nBG,Bulgaria,Sofia\nCY,Chipre,Nicosia\nDK,Dinamarca,Copenhague\nSK,Eslovaquia,Bratislava\nES,España,Madrid\nES,,Barcelona\nES,,Islas Canarias\nES,,Galicia\nES,,Sevilla\nFI,Finlandia,Helsinki\nFR,Francia,Paris\nGR,Grecia,Atenas\nHU,Hungria,Budapest\nIE,Irlanda,Dublin\nIT,Italia,Roma\nIT,,Milan\nKZ,Kazajstan,Astana\nRU,Rusia,Moscu\nNO,Noruega,Oslo\nNL,Paises Bajos,La Haya\nPL,Polonia,Varsovia\nPT,Portugal,Lisboa\nGB,Reino Unido De Gran Bretaña,Londres\nCZ,Republica Checa,Praga\nRO,Rumania,Bucarest\nRS,Serbia,Belgrado\nCH,Suiza,Berna\nTR,Turquia,Ankara\nTR,,Estambul\nCA,Canada,Montreal\nCA,,Toronto\nCA,,Ottawa\nSA,Arabia Saudita,Arabia Saudita\nDZ,Argelia,Argelia\nEG,Egipto,Egipto\nAE,EAU,EAU\nIR,Irán,Irán\nKW,Kuwait,Kuwait\nLB,Líbano,Líbano\nMA,Marruecos,Marruecos\nQA,Qatar,Qatar\nSY,Siria,Siria\nTN,Túnez,Túnez\nAO,Angola,Angola\nBJ,Benin,Benin\nBW,Bostwana,Bostwana\nBF,Burkina Faso,Burkina Faso\nCV,Cabo Verde,Cabo Verde\nCG,Congo Brazaville,Congo Brazaville\nCD,Congo Kinshasa,Congo Kinshasa\nDJ,Djibouti,Djibouti\nET,Etiopía,Etiopía\nGA,Gabón,Gabón\nGM,Gambia,Gambia\nGH,Ghana,Ghana\nGW,Guinea Bissau,Guinea Bissau`;
        const consuladosPorPaisISO = {}; const todosLosConsuladosISO = new Set(); let paisISOCodeActual = null;
        consuladosDataRawISO.split('\n').slice(1).forEach(line => { line = line.trim(); if (!line) return; const parts = line.split(','); const isoCode = parts[0].trim().toUpperCase(); let consulado = null; if (parts.length >= 3) { consulado = parts[parts.length - 1].trim(); } else if (parts.length === 2 && !isoCode) { consulado = parts[1].trim(); } else if (parts.length === 2 && isoCode) { consulado = parts[1].trim(); } if (isoCode && consulado) { paisISOCodeActual = isoCode; if (!consuladosPorPaisISO[paisISOCodeActual]) { consuladosPorPaisISO[paisISOCodeActual] = []; } consuladosPorPaisISO[paisISOCodeActual].push(consulado); todosLosConsuladosISO.add(consulado); } else if (!isoCode && consulado && paisISOCodeActual) { consuladosPorPaisISO[paisISOCodeActual].push(consulado); todosLosConsuladosISO.add(consulado); } });
        const allConsulatesISOSorted = Array.from(todosLosConsuladosISO).sort((a, b) => a.localeCompare(b));

        // Objeto que mapea nombres de consulados a sus códigos
        const consuladoCodigoPorNombre = {};
        consulados.forEach(c => {
            consuladoCodigoPorNombre[c.name] = c.code;
        });

        // --- Funciones Auxiliares ---
        // (populateSelect, populateCountrySelects, updateConsulados, getYearFromDateString, updateProvinciasMunicipiosByYear, handlePaisNacimientoChange - sin cambios)
        function populateSelect(selectElement, items, placeholder) { if (!selectElement) return; const currentValue = selectElement.value; selectElement.innerHTML = ''; const placeholderOption = document.createElement('option'); placeholderOption.value = ''; placeholderOption.textContent = placeholder; placeholderOption.disabled = true; placeholderOption.selected = true; selectElement.appendChild(placeholderOption); items.forEach(item => { const option = document.createElement('option'); option.value = item.value; option.textContent = item.textContent; selectElement.appendChild(option); }); if (items.some(item => item.value === currentValue)) { selectElement.value = currentValue; } }
        function populateCountrySelects() { const countrySelects = ['paisResidencia', 'paisNacimiento', 'paisResidenciaActual', 'paisTrabajo']; const sortedCountries = countries.sort((a, b) => a.name.localeCompare(b.name)); countrySelects.forEach(selectId => { const select = document.getElementById(selectId); if (select) { populateSelect(select, sortedCountries.map(country => ({ value: country.code, textContent: country.name })), 'Seleccione país'); } }); }
        function updateConsulados() {
            const paisResidenciaSelect = document.getElementById('paisResidencia');
            const consuladoSelect = document.getElementById('consulado');
            const selectedCountryCode = paisResidenciaSelect.value;
            let optionsToShow = [];

            console.log("País seleccionado (código numérico):", selectedCountryCode);

            // Obtener el código ISO correspondiente al código numérico seleccionado
            const isoCode = numericToIsoCode[selectedCountryCode];
            console.log("Código ISO correspondiente:", isoCode);
            console.log("Consulados disponibles para este ISO:", consuladosPorPaisISO[isoCode]);

            if (!isoCode && selectedCountryCode) {
                console.error("No se encontró código ISO para el código numérico:", selectedCountryCode);
                // Mostrar una alerta visual para depuración
                alert("Error: No se encontró código ISO para el país seleccionado (código " + selectedCountryCode + ")");
            }

            if (selectedCountryCode && isoCode && consuladosPorPaisISO[isoCode]) {
                // Usar los consulados del país seleccionado usando su código ISO
                const consuladosPais = consuladosPorPaisISO[isoCode].sort((a, b) => a.localeCompare(b));
                console.log("Consulados encontrados para", isoCode, ":", consuladosPais);

                optionsToShow = consuladosPais.map(nombreConsulado => {
                    // Buscar si existe un código para este consulado
                    let codigo = '';

                    // Intentar encontrar por nombre exacto
                    const consuladoObj = consulados.find(c => c.name.toUpperCase() === nombreConsulado.toUpperCase());
                    if (consuladoObj) {
                        codigo = consuladoObj.code;
                    }

                    return {
                        value: codigo || nombreConsulado,  // Si no hay código, usar el nombre como valor
                        textContent: nombreConsulado
                    };
                });

                consuladoSelect.disabled = false;
            } else if (selectedCountryCode) {
                console.log("No se encontraron consulados específicos, mostrando todos los consulados");
                // Mostrar todos los consulados si no hay consulados específicos para el país seleccionado
                optionsToShow = consulados.map(c => ({
                    value: c.code,
                    textContent: c.name
                })).sort((a, b) => a.textContent.localeCompare(b.textContent));

                consuladoSelect.disabled = false;
            } else {
                consuladoSelect.disabled = true;
            }

            populateSelect(consuladoSelect, optionsToShow, 'Seleccione un consulado');
        }
        function getYearFromDateString(dateString) { if (!dateString) return null; const date = new Date(dateString); return isNaN(date.getFullYear()) ? null : date.getFullYear(); }
        function updateProvinciasMunicipiosByYear(year) {
            const provinciaSelect = document.getElementById('provinciaNacimiento');
            const municipioSelect = document.getElementById('municipioNacimiento');
            let provincias;
            if (!year) {
                provincias = [];
            } else if (year < 1976) {
                provincias = provinciasHistoricas.before1976;
            } else if (year < 2011) {
                provincias = provinciasHistoricas.after1976;
            } else {
                provincias = provinciasHistoricas.after2011;
            }
            populateSelect(provinciaSelect, provincias.map(p => ({
                value: p.code, // Usar código en lugar del nombre formateado
                textContent: p.name
            })), 'Seleccione provincia');
            provinciaSelect.disabled = provincias.length === 0;
            populateSelect(municipioSelect, [], 'Seleccione municipio');
            municipioSelect.disabled = true;
            provinciaSelect.onchange = function () {
                const selectedProvinciaData = provincias.find(p => p.code === this.value);
                if (selectedProvinciaData) {
                    // Verificar si los municipios son objetos (nueva estructura) o strings (estructura antigua)
                    const municipiosList = selectedProvinciaData.municipios.map(m => {
                        if (typeof m === 'string') {
                            // Estructura antigua (solo nombres)
                            return {
                                value: m.toLowerCase().replace(/\s+/g, '_'),
                                textContent: m
                            };
                        } else {
                            // Nueva estructura (objetos con code y name)
                            return {
                                value: m.code,
                                textContent: m.name
                            };
                        }
                    });
                    populateSelect(municipioSelect, municipiosList, 'Seleccione municipio');
                    municipioSelect.disabled = false;
                } else {
                    populateSelect(municipioSelect, [], 'Seleccione municipio');
                    municipioSelect.disabled = true;
                }
            };
            if (provinciaSelect.value) {
                provinciaSelect.dispatchEvent(new Event('change'));
            }
        }
        function handlePaisNacimientoChange() { const paisNacimiento = document.getElementById('paisNacimiento').value; const fechaNacimiento = document.getElementById('fechaNacimiento').value; const provinciaSelect = document.getElementById('provinciaNacimiento'); const municipioSelect = document.getElementById('municipioNacimiento'); const provinciaText = document.getElementById('provinciaNacimientoText'); const municipioText = document.getElementById('municipioNacimientoText'); const provinciaContainer = document.getElementById('provinciaNacimientoContainer'); const municipioContainer = document.getElementById('municipioNacimientoContainer'); provinciaContainer.style.display = 'block'; municipioContainer.style.display = 'block'; if (paisNacimiento === '1') { provinciaSelect.style.display = 'block'; municipioSelect.style.display = 'block'; provinciaText.style.display = 'none'; municipioText.style.display = 'none'; provinciaSelect.required = true; municipioSelect.required = true; provinciaText.required = false; municipioText.required = false; const year = getYearFromDateString(fechaNacimiento); updateProvinciasMunicipiosByYear(year); } else { provinciaSelect.style.display = 'none'; municipioSelect.style.display = 'none'; provinciaText.style.display = 'block'; municipioText.style.display = 'block'; provinciaSelect.required = false; municipioSelect.required = false; provinciaText.required = true; municipioText.required = true; provinciaText.disabled = false; municipioText.disabled = false; populateSelect(provinciaSelect, [], 'Seleccione provincia'); populateSelect(municipioSelect, [], 'Seleccione municipio'); provinciaSelect.disabled = true; municipioSelect.disabled = true; } }

        // --- Event Listeners y Población del Formulario ---
        // (DOMContentLoaded - sin cambios significativos)
        document.addEventListener('DOMContentLoaded', function () {
            const fechaSolicitudInput = document.getElementById('fechaSolicitud'); if (fechaSolicitudInput) { const today = new Date().toISOString().split('T')[0]; fechaSolicitudInput.value = today; }
            populateCountrySelects();
            const paisNacimientoSelect = document.getElementById('paisNacimiento'); if (paisNacimientoSelect) { paisNacimientoSelect.value = '1'; }

            fetch('https://ipapi.co/json/').then(response => response.ok ? response.json() : Promise.reject('Failed to fetch IP info')).then(data => {
                if (data && data.country_code) {
                    const paisResidenciaSelect = document.getElementById('paisResidencia');
                    const paisResidenciaActualSelect = document.getElementById('paisResidenciaActual');
                    const countryCode = data.country_code;

                    // Convertir código ISO a código numérico
                    const numericCode = isoToNumericCode[countryCode] || '';

                    if (paisResidenciaSelect && !paisResidenciaSelect.value) {
                        paisResidenciaSelect.value = numericCode;
                        paisResidenciaSelect.dispatchEvent(new Event('change'));
                    }
                    if (paisResidenciaActualSelect && !paisResidenciaActualSelect.value) {
                        paisResidenciaActualSelect.value = numericCode;
                    }
                }
            }).catch(error => {
                console.warn('Could not fetch IP info:', error);
                updateConsulados();
            }).finally(() => {
                handlePaisNacimientoChange();
                updateConsulados();
            });

            // Asegurar que el evento change esté correctamente configurado para paisResidencia
            const paisResidenciaSelect = document.getElementById('paisResidencia');
            if (paisResidenciaSelect) {
                // Eliminar cualquier manejador de eventos existente para evitar duplicados
                paisResidenciaSelect.removeEventListener('change', updateConsulados);
                // Agregar el manejador de eventos
                paisResidenciaSelect.addEventListener('change', function () {
                    console.log("Evento change detectado en País de Residencia");
                    updateConsulados();
                });
            }

            ['paisNacimiento', 'fechaNacimiento'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('change', () => {
                    if (id === 'paisNacimiento' || id === 'fechaNacimiento') handlePaisNacimientoChange();
                });
            });
            const referenceProvinciaSelect = document.getElementById('referenciaProvincia');
            const referenciaMunicipioSelect = document.getElementById('referenciaMunicipio');
            const currentProvinces = provinciasHistoricas.after2011;
            populateSelect(referenceProvinciaSelect, currentProvinces.map(p => ({
                value: p.code, // Usar código en lugar del nombre formateado
                textContent: p.name
            })), 'Seleccione provincia');
            referenceProvinciaSelect.addEventListener('change', function () {
                const selectedProvincia = currentProvinces.find(p => p.code === this.value);
                if (selectedProvincia) {
                    // Verificar si los municipios son objetos (nueva estructura) o strings (estructura antigua)
                    const municipiosList = selectedProvincia.municipios.map(m => {
                        if (typeof m === 'string') {
                            // Estructura antigua (solo nombres)
                            return {
                                value: m.toLowerCase().replace(/\s+/g, '_'),
                                textContent: m
                            };
                        } else {
                            // Nueva estructura (objetos con code y name)
                            return {
                                value: m.code,
                                textContent: m.name
                            };
                        }
                    });
                    populateSelect(referenciaMunicipioSelect, municipiosList, 'Seleccione municipio');
                    referenciaMunicipioSelect.disabled = false;
                } else {
                    populateSelect(referenciaMunicipioSelect, [], 'Seleccione municipio');
                    referenciaMunicipioSelect.disabled = true;
                }
            });
        });

        // --- Mapeo de Campos ---
        // (fieldMapping - sin cambios)
        const fieldMapping = [{ id: 1, field: 'fechaSolicitud', label: 'Fecha de Solicitud' }, { id: 2, field: 'tramite', label: 'Tipo de Trámite' }, { id: 3, field: 'paisResidencia', label: 'País de Residencia' }, { id: 4, field: 'consulado', label: 'Consulado' }, { id: 5, field: 'numeroPasaporte', label: 'Número de Pasaporte' }, { id: 6, field: 'carneIdentidad', label: 'Carné de Identidad' }, { id: 7, field: 'fechaNacimiento', label: 'Fecha de Nacimiento' }, { id: 8, field: 'sexo', label: 'Sexo' }, { id: 9, field: 'primerApellido', label: 'Primer Apellido' }, { id: 10, field: 'segundoApellido', label: 'Segundo Apellido' }, { id: 11, field: 'primerNombre', label: 'Primer Nombre' }, { id: 12, field: 'segundoNombre', label: 'Segundo Nombre' }, { id: 13, field: 'nombrePadre', label: 'Nombre del Padre' }, { id: 14, field: 'nombreMadre', label: 'Nombre de la Madre' }, { id: 15, field: 'paisNacimiento', label: 'País de Nacimiento' }, { id: 16, field: 'provinciaNacimiento', label: 'Provincia Nacimiento (Cuba)', conditional: (data) => data[15] === '1' }, { id: 17, field: 'municipioNacimiento', label: 'Municipio Nacimiento (Cuba)', conditional: (data) => data[15] === '1' }, { id: 16.1, field: 'provinciaNacimientoText', label: 'Provincia Nacimiento (Otro)', conditional: (data) => data[15] !== '1' }, { id: 17.1, field: 'municipioNacimientoText', label: 'Municipio Nacimiento (Otro)', conditional: (data) => data[15] !== '1' }, { id: 18, field: 'colorOjos', label: 'Color de Ojos' }, { id: 19, field: 'colorPiel', label: 'Color de Piel' }, { id: 20, field: 'colorCabello', label: 'Color de Cabello' }, { id: 21, field: 'estatura', label: 'Estatura' }, { id: 22, field: 'estadoCivil', label: 'Estado Civil' }, { id: 23, field: 'diaSalida', label: 'Día de Salida' }, { id: 24, field: 'mesSalida', label: 'Mes de Salida' }, { id: 25, field: 'anoSalida', label: 'Año de Salida' }, { id: 26, field: 'direccionResidencia', label: 'Dirección de Residencia' }, { id: 27, field: 'codigoPostalResidencia', label: 'Código Postal Residencia' }, { id: 28, field: 'provinciaEstadoResidencia', label: 'Provincia/Estado Residencia' }, { id: 29, field: 'paisResidenciaActual', label: 'País de Residencia Actual' }, { id: 30, field: 'telefonoResidencia', label: 'Teléfono Residencia' }, { id: 31, field: 'emailResidencia', label: 'Email Residencia' }, { id: 32, field: 'faxResidencia', label: 'Fax Residencia' }, { id: 33, field: 'nombreCentroTrabajo', label: 'Centro de Trabajo/Estudio' }, { id: 34, field: 'profesionTrabajo', label: 'Profesión' }, { id: 35, field: 'ocupacionTrabajo', label: 'Ocupación' }, { id: 36, field: 'direccionTrabajo', label: 'Dirección Trabajo' }, { id: 37, field: 'codigoPostalTrabajo', label: 'Código Postal Trabajo' }, { id: 38, field: 'provinciaEstadoTrabajo', label: 'Provincia/Estado Trabajo' }, { id: 39, field: 'paisTrabajo', label: 'País Trabajo' }, { id: 40, field: 'telefonoTrabajo', label: 'Teléfono Trabajo' }, { id: 41, field: 'emailTrabajo', label: 'Email Trabajo' }, { id: 42, field: 'faxTrabajo', label: 'Fax Trabajo' }, { id: 43, field: 'nivelCultural', label: 'Nivel Cultural' }, { id: 44, field: 'ocupacionActual', label: 'Ocupación Actual' }, { id: 45, field: 'profesionOficio', label: 'Profesión u Oficio' }, { id: 46, field: 'referenciaNombre', label: 'Nombre Referencia' }, { id: 47, field: 'tipoVinculo', label: 'Tipo de Vínculo' }, { id: 48, field: 'referenciaDireccion', label: 'Dirección Referencia' }, { id: 49, field: 'referenciaProvincia', label: 'Provincia Referencia' }, { id: 50, field: 'referenciaMunicipio', label: 'Municipio Referencia' }, { id: 51, field: 'direccionCuba1', label: 'Dirección Cuba 1' }, { id: 52, field: 'desdeCuba1', label: 'Desde Cuba 1' }, { id: 53, field: 'hastaCuba1', label: 'Hasta Cuba 1' }, { id: 54, field: 'direccionCuba2', label: 'Dirección Cuba 2' }, { id: 55, field: 'desdeCuba2', label: 'Desde Cuba 2' }, { id: 56, field: 'hastaCuba2', label: 'Hasta Cuba 2' }, { id: 57, field: 'pasaporteNumeroVencido', label: 'Número Pasaporte Vencido' }, { id: 58, field: 'pasaporteFechaExpedicionVencido', label: 'Fecha Expedición Pasaporte' }, { id: 59, field: 'pasaporteLugarExpedicionVencido', label: 'Lugar Expedición Pasaporte' }, { id: 60, field: 'certNacimientoTomo', label: 'Tomo Nacimiento' }, { id: 61, field: 'certNacimientoFolio', label: 'Folio Nacimiento' }, { id: 62, field: 'certNacimientoRegistroCivil', label: 'Registro Civil' }, { id: 63, field: 'inscripcionConsularNumero', label: 'Número Inscripción Consular' }, { id: 64, field: 'inscripcionConsularFecha', label: 'Fecha Inscripción Consular' }];

        // --- Generación de PDF y QR ---
        // Función para validar el formulario
        function validateForm() {
            // Obtener todos los campos requeridos
            const requiredFields = document.querySelectorAll('[required]');
            let isValid = true;
            let firstInvalidField = null;
            let errorMessage = '';

            // Limpiar errores previos
            document.querySelectorAll('.error-field').forEach(field => {
                field.classList.remove('error-field');
            });

            // Validar todas las fechas
            const today = new Date();
            const minYear = 1900;

            // Función auxiliar para validar fechas
            function validateDateField(field, fieldName) {
                if (field && field.value) {
                    const date = new Date(field.value);
                    if (isNaN(date.getTime())) {
                        field.classList.add('error-field');
                        isValid = false;
                        errorMessage = `La fecha ${fieldName} no es válida`;
                        if (!firstInvalidField) firstInvalidField = field;
                        return false;
                    }

                    const year = date.getFullYear();
                    if (year < minYear) {
                        field.classList.add('error-field');
                        isValid = false;
                        errorMessage = `La fecha ${fieldName} no puede ser anterior a ${minYear}`;
                        if (!firstInvalidField) firstInvalidField = field;
                        return false;
                    }

                    if (date > today) {
                        field.classList.add('error-field');
                        isValid = false;
                        errorMessage = `La fecha ${fieldName} no puede ser posterior a hoy`;
                        if (!firstInvalidField) firstInvalidField = field;
                        return false;
                    }
                }
                return true;
            }

            // Validar fecha de solicitud
            validateDateField(document.getElementById('fechaSolicitud'), 'de solicitud');

            // Validar fecha de nacimiento
            validateDateField(document.getElementById('fechaNacimiento'), 'de nacimiento');

            // Validar años en la tabla de residencias en Cuba
            const yearFields = ['desdeCuba1', 'hastaCuba1', 'desdeCuba2', 'hastaCuba2'];
            yearFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && field.value) {
                    const year = parseInt(field.value);
                    if (isNaN(year) || year < minYear || year > today.getFullYear()) {
                        field.classList.add('error-field');
                        isValid = false;
                        errorMessage = `El año debe estar entre ${minYear} y ${today.getFullYear()}`;
                        if (!firstInvalidField) firstInvalidField = field;
                    }
                }
            });

            // Validar el carné de identidad si tiene valor
            const carneIdentidad = document.getElementById('carneIdentidad');
            if (carneIdentidad && carneIdentidad.value) {
                const value = carneIdentidad.value;

                if (!/^\d{11}$/.test(value)) {
                    carneIdentidad.classList.add('error-field');
                    isValid = false;
                    errorMessage = 'El carné de identidad debe tener exactamente 11 dígitos';
                    if (!firstInvalidField) firstInvalidField = carneIdentidad;
                } else {
                    // Validar fecha del carné
                    const year = parseInt(value.substring(0, 2));
                    const month = parseInt(value.substring(2, 4));
                    const day = parseInt(value.substring(4, 6));

                    const currentYear = new Date().getFullYear() % 100;
                    const century = year <= currentYear ? 2000 : 1900;
                    const fullYear = century + year;

                    const date = new Date(fullYear, month - 1, day);
                    const isValidDate = date.getMonth() === month - 1 &&
                        date.getDate() === day &&
                        date.getFullYear() === fullYear;

                    if (!isValidDate || fullYear < minYear) {
                        carneIdentidad.classList.add('error-field');
                        isValid = false;
                        errorMessage = 'La fecha en el carné de identidad no es válida o es anterior a 1900';
                        if (!firstInvalidField) firstInvalidField = carneIdentidad;
                    } else {
                        // Verificar que la fecha no sea futura
                        if (date > today) {
                            carneIdentidad.classList.add('error-field');
                            isValid = false;
                            errorMessage = 'La fecha del carné no puede ser futura';
                            if (!firstInvalidField) firstInvalidField = carneIdentidad;
                        }

                        // Verificar edad mínima de 16 años
                        const age = today.getFullYear() - fullYear;
                        if (age < 16 || (age === 16 && today.getMonth() < date.getMonth()) ||
                            (age === 16 && today.getMonth() === date.getMonth() && today.getDate() < date.getDate())) {
                            carneIdentidad.classList.add('error-field');
                            isValid = false;
                            errorMessage = 'La persona debe tener al menos 16 años';
                            if (!firstInvalidField) firstInvalidField = carneIdentidad;
                        }
                    }
                }
            }

            // Validar formato de correos electrónicos
            const emailFields = ['emailResidencia', 'emailTrabajo'];
            const emailPattern = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/;

            emailFields.forEach(fieldId => {
                const emailField = document.getElementById(fieldId);
                if (emailField && emailField.value) {
                    const email = emailField.value.toLowerCase();
                    if (!emailPattern.test(email)) {
                        emailField.classList.add('error-field');
                        isValid = false;
                        errorMessage = 'El formato del correo electrónico no es válido';
                        if (!firstInvalidField) firstInvalidField = emailField;
                    }
                }
            });

            // Validar la fecha de salida de Cuba (día, mes, año)
            const diaSalida = document.getElementById('diaSalida');
            const mesSalida = document.getElementById('mesSalida');
            const anoSalida = document.getElementById('anoSalida');

            if ((diaSalida && diaSalida.value) ||
                (mesSalida && mesSalida.value) ||
                (anoSalida && anoSalida.value)) {

                const dia = parseInt(diaSalida.value) || 1;
                const mes = parseInt(mesSalida.value) || 1;
                const ano = parseInt(anoSalida.value);

                if (ano) {
                    if (ano < minYear || ano > today.getFullYear()) {
                        anoSalida.classList.add('error-field');
                        isValid = false;
                        errorMessage = `El año de salida debe estar entre ${minYear} y ${today.getFullYear()}`;
                        if (!firstInvalidField) firstInvalidField = anoSalida;
                    } else {
                        const fechaSalida = new Date(ano, mes - 1, dia);
                        if (fechaSalida > today) {
                            const campoConError = dia !== 1 ? diaSalida :
                                mes !== 1 ? mesSalida : anoSalida;
                            campoConError.classList.add('error-field');
                            isValid = false;
                            errorMessage = 'La fecha de salida no puede ser posterior a hoy';
                            if (!firstInvalidField) firstInvalidField = campoConError;
                        }
                    }
                }
            }

            // Validar campos requeridos
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('error-field');
                    isValid = false;
                    if (!firstInvalidField) {
                        firstInvalidField = field;
                        errorMessage = 'Por favor, complete todos los campos obligatorios';
                    }
                }
            });

            // Si hay campos inválidos, mostrar mensaje y enfocar el primer campo
            if (!isValid) {
                Toastify({
                    text: errorMessage,
                    duration: 5000,
                    gravity: "top",
                    position: 'right',
                    className: "error"
                }).showToast();

                if (firstInvalidField) {
                    firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstInvalidField.focus();
                }
            }

            return isValid;
        }

        // Función auxiliar para convertir archivos a base64
        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Función para obtener todos los valores del formulario
        async function getFormValues() {
            // Primero obtenemos los datos del formulario sin las imágenes
            const formData = {
                // Datos iniciales
                tramite: document.getElementById('tramite')?.value || '',
                consulado: document.getElementById('consulado')?.value || '',
                fechaSolicitud: document.getElementById('fechaSolicitud')?.value || '',

                // Datos personales
                numeroPasaporte: document.getElementById('numeroPasaporte')?.value || '',
                carneIdentidad: document.getElementById('carneIdentidad')?.value || '',
                primerApellido: document.getElementById('primerApellido')?.value || '',
                segundoApellido: document.getElementById('segundoApellido')?.value || '',
                primerNombre: document.getElementById('primerNombre')?.value || '',
                segundoNombre: document.getElementById('segundoNombre')?.value || '',

                // Fecha de nacimiento - obtenida directamente del campo de fecha
                fechaNacimiento: (() => {
                    try {
                        const fechaNacimiento = document.getElementById('fechaNacimiento')?.value;
                        if (!fechaNacimiento) {
                            console.warn('No se proporcionó fecha de nacimiento, usando valor por defecto');
                            return '1900-01-01';
                        }
                        // Asegurarse de que la fecha esté en formato YYYY-MM-DD
                        const fecha = new Date(fechaNacimiento);
                        if (isNaN(fecha.getTime())) {
                            console.error('Fecha de nacimiento inválida:', fechaNacimiento);
                            return '1900-01-01';
                        }
                        // Formatear a YYYY-MM-DD
                        const fechaFormateada = fecha.toISOString().split('T')[0];
                        console.log('Fecha de nacimiento formateada:', fechaFormateada);
                        return fechaFormateada;
                    } catch (error) {
                        console.error('Error al procesar la fecha de nacimiento:', error);
                        return '1900-01-01'; // Valor por defecto en caso de error
                    }
                })(),


                // Lugar de nacimiento
                paisNacimiento: document.getElementById('paisNacimiento')?.value || '',
                provinciaNacimiento: document.getElementById('provinciaNacimiento')?.value ||
                    document.getElementById('provinciaNacimientoText')?.value || '',
                municipioNacimiento: document.getElementById('municipioNacimiento')?.value ||
                    document.getElementById('municipioNacimientoText')?.value || '',

                // Datos personales adicionales
                sexo: document.getElementById('sexo')?.value || '',
                estadoCivil: document.getElementById('estadoCivil')?.value || '',
                colorOjos: document.getElementById('colorOjos')?.value || '',
                colorPiel: document.getElementById('colorPiel')?.value || '',
                colorCabello: document.getElementById('colorCabello')?.value || '',
                estatura: document.getElementById('estatura')?.value || '',

                // Nombres de los padres
                nombrePadre: document.getElementById('nombrePadre')?.value || '',
                nombreMadre: document.getElementById('nombreMadre')?.value || '',

                // Fecha de salida de Cuba
                fechaSalidaCuba: (() => {
                    const dia = document.getElementById('diaSalida')?.value || '';
                    const mes = document.getElementById('mesSalida')?.value || '';
                    const ano = document.getElementById('anoSalida')?.value || '';
                    return (ano && mes && dia) ? `${ano}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}` : '';
                })(),

                // Dirección de residencia actual
                direccionResidencia: document.getElementById('direccionResidencia')?.value || '',
                codigoPostalResidencia: document.getElementById('codigoPostalResidencia')?.value || '',
                provinciaEstadoResidencia: document.getElementById('provinciaEstadoResidencia')?.value || '',
                paisResidenciaActual: document.getElementById('paisResidenciaActual')?.value || '',
                telefonoResidencia: document.getElementById('telefonoResidencia')?.value || '',
                emailResidencia: document.getElementById('emailResidencia')?.value || '',
                faxResidencia: document.getElementById('faxResidencia')?.value || '',

                // Datos laborales/estudio
                nombreCentroTrabajo: document.getElementById('nombreCentroTrabajo')?.value || '',
                nivelCultural: document.getElementById('nivelCultural')?.value || '',
                profesionTrabajo: document.getElementById('profesionTrabajo')?.value || '',
                ocupacionTrabajo: document.getElementById('ocupacionTrabajo')?.value || '',
                direccionTrabajo: document.getElementById('direccionTrabajo')?.value || '',
                codigoPostalTrabajo: document.getElementById('codigoPostalTrabajo')?.value || '',
                provinciaEstadoTrabajo: document.getElementById('provinciaEstadoTrabajo')?.value || '',
                paisTrabajo: document.getElementById('paisTrabajo')?.value || '',
                telefonoTrabajo: document.getElementById('telefonoTrabajo')?.value || '',
                emailTrabajo: document.getElementById('emailTrabajo')?.value || '',
                faxTrabajo: document.getElementById('faxTrabajo')?.value || '',

                // Información adicional
                referenciaNombre: document.getElementById('referenciaNombre')?.value || '',
                tipoVinculo: document.getElementById('tipoVinculo')?.value || '',
                referenciaDireccion: document.getElementById('referenciaDireccion')?.value || '',
                referenciaProvincia: document.getElementById('referenciaProvincia')?.value || '',
                referenciaMunicipio: document.getElementById('referenciaMunicipio')?.value || '',

                // Direcciones en Cuba
                direccionCuba1: document.getElementById('direccionCuba1')?.value || '',
                desdeCuba1: document.getElementById('desdeCuba1')?.value || '',
                hastaCuba1: document.getElementById('hastaCuba1')?.value || '',
                direccionCuba2: document.getElementById('direccionCuba2')?.value || '',
                desdeCuba2: document.getElementById('desdeCuba2')?.value || '',
                hastaCuba2: document.getElementById('hastaCuba2')?.value || ''
            };


            // Procesar archivos (foto, firma, huella) solo para el PDF
            const processFile = (file) => {
                if (file) {
                    return getBase64(file);
                }
                return Promise.resolve('');
            };

            // Procesar archivos en paralelo
            const [foto, firma, huella] = await Promise.all([
                document.getElementById('photoInput')?.files?.[0] ?
                    processFile(document.getElementById('photoInput').files[0]) : '',
                document.getElementById('signatureInput')?.files?.[0] ?
                    processFile(document.getElementById('signatureInput').files[0]) : '',
                document.getElementById('fingerprintInput')?.files?.[0] ?
                    processFile(document.getElementById('fingerprintInput').files[0]) : ''
            ]);


            // Crear una copia de los datos del formulario para el PDF (incluyendo las imágenes)
            const pdfFormData = { ...formData };
            pdfFormData.foto = foto;
            pdfFormData.firma = firma;
            pdfFormData.huella = huella;

            // Validar que los datos del QR no contengan campos de imagen
            const hasImageFieldsInQR = 'foto' in formData || 'firma' in formData || 'huella' in formData;
            if (hasImageFieldsInQR) {
                console.warn('Advertencia: Los datos del QR contienen campos de imagen. Esto no debería ocurrir.');
                // Eliminar cualquier campo de imagen que pueda haber quedado
                delete formData.foto;
                delete formData.firma;
                delete formData.huella;
            }

            // Validar que los datos del PDF sí contengan las imágenes
            const hasImagesInPDF = pdfFormData.foto || pdfFormData.firma || pdfFormData.huella;
            if (!hasImagesInPDF) {
                console.warn('Advertencia: Los datos del PDF no contienen campos de imagen. Asegúrate de que se estén subiendo las imágenes correctamente.');
            }

            // Depuración: Mostrar la fecha de nacimiento antes de crear el arreglo
            console.log('Fecha de nacimiento en formData:', formData.fechaNacimiento);
            
            // Asegurarse de que la fecha de nacimiento esté presente
            if (!formData.fechaNacimiento) {
                console.warn('La fecha de nacimiento está vacía, usando valor por defecto');
                formData.fechaNacimiento = '1900-01-01';
            }

            // Crear el arreglo del QR siguiendo el orden especificado en la documentación
            const qrDataArray = [
                formData.tramite || '',
                formData.consulado || '',
                formData.fechaSolicitud || '',
                formData.numeroPasaporte || '',
                formData.carneIdentidad || '',
                formData.primerApellido || '',
                formData.segundoApellido || '',
                formData.primerNombre || '',
                formData.segundoNombre || '',
                formData.fechaNacimiento || '',
                formData.paisNacimiento || '',
                formData.provinciaNacimiento || '',
                formData.municipioNacimiento || '',
                formData.sexo || '',
                formData.estadoCivil || '',
                formData.colorOjos || '',
                formData.colorPiel || '',
                formData.colorCabello || '',
                formData.estatura || '',
                formData.nombrePadre || '',
                formData.nombreMadre || '',
                formData.fechaSalidaCuba || '',
                formData.direccionResidencia || '',
                formData.codigoPostalResidencia || '',
                formData.provinciaEstadoResidencia || '',
                formData.paisResidenciaActual || '',
                formData.telefonoResidencia || '',
                formData.emailResidencia || '',
                formData.faxResidencia || '',
                formData.nombreCentroTrabajo || '',
                formData.nivelCultural || '',
                formData.profesionTrabajo || '',
                formData.ocupacionTrabajo || '',
                formData.direccionTrabajo || '',
                formData.codigoPostalTrabajo || '',
                formData.provinciaEstadoTrabajo || '',
                formData.paisTrabajo || '',
                formData.telefonoTrabajo || '',
                formData.emailTrabajo || '',
                formData.faxTrabajo || '',
                formData.referenciaNombre || '',
                formData.tipoVinculo || '',
                formData.referenciaDireccion || '',
                formData.referenciaProvincia || '',
                formData.referenciaMunicipio || '',
                formData.direccionCuba1 || '',
                formData.desdeCuba1 || '',
                formData.hastaCuba1 || '',
                formData.direccionCuba2 || '',
                formData.desdeCuba2 || '',
                formData.hastaCuba2 || ''
            ];


            // Devolver un objeto con ambos conjuntos de datos
            return {
                qrData: qrDataArray,  // Datos para el QR como arreglo plano
                pdfData: pdfFormData  // Todos los datos incluyendo imágenes para el PDF
            };
        }

        // Función común para generar el código QR
        async function generateQR() {
            try {
                // Obtener los valores del formulario (solo datos de texto para el QR)
                const { qrData } = await getFormValues();

                // Convertir a JSON con formato legible para depuración
                const qrJson = JSON.stringify(qrData, null, 2);

                // Generar el QR con QRious
                const qrContainer = document.getElementById('qrCode');
                qrContainer.innerHTML = '<div class="qr-title">Código de verificación del documento</div><canvas id="qr"></canvas>';

                // Usar directamente los datos JSON sin codificación adicional
                // QRious maneja la codificación UTF-8 internamente
                new QRious({
                    element: document.getElementById('qr'),
                    value: qrJson,
                    size: 300,
                    level: 'H', // Nivel de corrección de errores más alto
                    background: '#ffffff',
                    foreground: '#1a365d',
                    padding: 25
                });

                // Mostrar datos generados para depuración (opcional)
                console.log('Datos del QR generados (arreglo):', qrData);
                console.log('JSON del QR generado:', qrJson);
                return qrJson;
            } catch (error) {
                console.error('Error al generar el código QR:', error);
                showToast('Error al generar el código QR: ' + error.message, 'error');
                return null;
            }
        }

        async function generatePDF() {
            if (!validateForm()) return;

            try {
                document.getElementById('loader').style.display = 'flex';

                // Ajustar el tamaño de la fuente para todos los campos de texto
                document.querySelectorAll('input[type="text"], input[type="tel"], input[type="email"], textarea').forEach(input => {
                    const tempSpan = document.createElement('span');
                    tempSpan.style.visibility = 'hidden';
                    tempSpan.style.position = 'absolute';
                    tempSpan.style.whiteSpace = 'nowrap';
                    tempSpan.textContent = input.value;
                    document.body.appendChild(tempSpan);

                    const inputWidth = input.offsetWidth;
                    const textWidth = tempSpan.offsetWidth;

                    document.body.removeChild(tempSpan);

                    if (textWidth > inputWidth) {
                        const ratio = inputWidth / textWidth;
                        const newFontSize = Math.max(8, Math.floor(14 * ratio)); // No permitir tamaño menor a 8px
                        input.style.fontSize = `${newFontSize}px`;
                    }
                });


                // Obtener los datos del formulario (incluyendo imágenes para el PDF)
                const { qrData, pdfData } = await getFormValues();
                
                // Generar el código QR con los datos de texto
                await generateQR();

                // Esperar a que se genere el QR
                await new Promise(resolve => setTimeout(resolve, 200));

                // Generar el PDF
                const element = document.getElementById('form-to-print');
                const opt = {
                    margin: [8, 5, 8, 5],
                    filename: 'solicitud_pasaporte.pdf',
                    image: { type: 'jpeg', quality: 0.95 },
                    html2canvas: {
                        scale: 2,
                        useCORS: true,
                        logging: false
                    },
                    jsPDF: {
                        unit: 'mm',
                        format: 'a4',
                        orientation: 'portrait'
                    }
                };

                await html2pdf().from(element).set(opt).save();

                // Restaurar el tamaño de fuente original después de generar el PDF
                document.querySelectorAll('input[type="text"], input[type="tel"], input[type="email"], textarea').forEach(input => {
                    input.style.fontSize = '14px'; // Restaurar al tamaño original
                });

                Toastify({
                    text: "PDF generado exitosamente",
                    duration: 3000,
                    gravity: "top",
                    position: 'right',
                    className: "success"
                }).showToast();

            } catch (error) {
                console.error('Error generando PDF:', error);
                Toastify({
                    text: "Error generando el PDF: " + error.message,
                    duration: 5000,
                    gravity: "top",
                    position: 'right',
                    className: "error"
                }).showToast();
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        // Add continue iteration functionality
        // function continueIteration() {
        //     // Reset form fields but keep the header information
        //     const fieldsToKeep = ['fechaSolicitud', 'tramite', 'paisResidencia', 'consulado'];
        //     const savedValues = {};

        //     // Save values we want to keep
        //     fieldsToKeep.forEach(fieldId => {
        //         const element = document.getElementById(fieldId);
        //         if (element) {
        //             savedValues[fieldId] = element.value;
        //         }
        //     });

        //     // Reset form
        //     document.querySelectorAll('input, select, textarea').forEach(element => {
        //         if (element.type === 'file') {
        //             // Reset file input
        //             element.value = '';
        //             // Reset photo preview if exists
        //             const photoPreview = document.getElementById('uploadedPhoto');
        //             if (photoPreview) {
        //                 photoPreview.style.display = 'none';
        //             }
        //             const photoPlaceholder = document.getElementById('photoPlaceholder');
        //             if (photoPlaceholder) {
        //                 photoPlaceholder.style.display = 'block';
        //             }
        //         } else {
        //             element.value = '';
        //         }
        //     });

        //     // Restore saved values
        //     Object.entries(savedValues).forEach(([fieldId, value]) => {
        //         const element = document.getElementById(fieldId);
        //         if (element) {
        //             element.value = value;
        //         }
        //     });

        //     // Hide the continue button
        //     document.getElementById('continueBtn').style.display = 'none';

        //     // Scroll to top
        //     window.scrollTo(0, 0);

        //     // Show a confirmation message
        //     Toastify({
        //         text: "Form reset for next entry. Header information preserved.",
        //         duration: 3000,
        //         gravity: "top",
        //         position: 'center',
        //         style: {
        //             background: "linear-gradient(135deg, #00C851, #007E33)"
        //         }
        //     }).showToast();
        // }

        // Función para generar solo el QR
        async function generateOnlyQR() {
            if (!validateForm()) return;

            try {
                // Mostrar indicador de carga
                const loader = document.createElement('div');
                loader.className = 'loader';
                const qrContainer = document.getElementById('qrCode');
                qrContainer.innerHTML = '';
                qrContainer.appendChild(loader);

                // Generar el código QR
                await generateQR();

                // Mostrar mensaje de éxito
                showToast("Código QR generado exitosamente", 'success');

            } catch (error) {
                console.error('Error generando QR:', error);
                showToast("Error generando el código QR: " + error.message, 'error');
            }
        }

        function handlePhotoUpload(input) {
            const file = input.files[0];
            const photoPreview = document.getElementById('uploadedPhoto');
            const photoPlaceholder = document.getElementById('photoPlaceholder');

            if (!file) return;

            // Validación de tipo de archivo
            if (!file.type.startsWith('image/')) {
                showToast('Por favor, seleccione un archivo de imagen válido (JPG o PNG)', 'error');
                input.value = '';
                return;
            }

            // Validación de tamaño (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('La imagen no debe exceder 5MB', 'error');
                input.value = '';
                return;
            }

            const img = new Image();
            img.onload = function () {
                // Validar dimensiones (proporción aproximada 4:4.5)
                const aspectRatio = this.width / this.height;
                const expectedRatio = 4 / 4.5;
                const tolerance = 0.2; // 20% de tolerancia

                if (Math.abs(aspectRatio - expectedRatio) > tolerance) {
                    showToast('La imagen debe tener una proporción aproximada de 4:4.5 cm', 'error');
                    input.value = '';
                    photoPreview.style.display = 'none';
                    photoPlaceholder.style.display = 'block';
                    return;
                }

                // Mostrar la imagen
                photoPreview.src = URL.createObjectURL(file);
                photoPreview.style.display = 'block';
                photoPlaceholder.style.display = 'none';
            };

            img.onerror = function () {
                showToast('Error al cargar la imagen. Por favor, intente con otra.', 'error');
                input.value = '';
            };

            img.src = URL.createObjectURL(file);
        }

        function showToast(message, type = 'error') {
            Toastify({
                text: message,
                duration: 3000,
                gravity: "top",
                position: "center",
                className: type,
                style: {
                    background: type === 'error' ? "linear-gradient(to right, #ff4444, #cc0000)" :
                        "linear-gradient(to right, #00C851, #007E33)"
                }
            }).showToast();
        }
    </script>
</body>

</html>